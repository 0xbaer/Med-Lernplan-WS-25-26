<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Medi-Lernplan WS 25/26 (V20 - W√∂chentliche Sprints)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
        }
        .task-item input:checked + label .edit-span {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .task-item label, .goal-item .edit-span {
            transition: color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-block; 
            width: 100%;
        }
        .goal-item .edit-span:hover, .task-item label .edit-span:hover {
            background-color: #eff6ff; /* blue-50 */
            border-radius: 3px;
            box-shadow: 0 0 0 1px #dbeafe; /* blue-100 */
        }
        #save-status.syncing::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' '; }
        }
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            font-weight: bold;
            padding: 0 4px;
            font-family: monospace;
            color: #ef4444; /* red-500 */
            align-self: flex-start;
        }
        .learn-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            padding: 0 6px;
            align-self: flex-start;
        }
        .task-item:hover .delete-btn, .goal-item:hover .delete-btn,
        .task-item:hover .learn-btn, .goal-item:hover .learn-btn {
            opacity: 1;
        }
        .editing-input {
            width: 95%;
            padding: 2px 4px;
            border: 1px solid #3b82f6; /* blue-500 */
            border-radius: 3px;
            outline: none;
            font: inherit;
        }
        .phase-status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        #resource-menu {
            transition: transform 0.3s ease-in-out;
        }
        #menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .menu-hidden {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="h-full p-4 md:p-8 bg-gray-100">

    <!-- Overlay f√ºr Men√º -->
    <div id="menu-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-30 hidden"></div>

    <!-- Ressourcen-Men√º (Slide-Over) -->
    <div id="resource-menu" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl z-40 p-6 menu-hidden overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-900">Ressourcen</h2>
            <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p class="text-sm text-gray-600 mb-4">
            <!-- HINWEIS: Ersetze die 'href' #" Platzhalter unten mit deinen echten Google Drive / Cloud-Links -->
        </p>
        <ul class="space-y-3">
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5M8.25 6.253l-3 3m3-3l3 3M6.253 18v-3.375c0-1.02.84-1.875 1.875-1.875h7.75c1.035 0 1.875.855 1.875 1.875V18M17.75 6.253l-3 3m3-3l3 3"></path></svg>
                    Anatomie 1: Allg./Extrem.
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 12.75l6 6 9-13.5"></path></svg>
                    Anatomie 2: Eingeweide
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Anatomie 3: Kopf, Hals, ZNS
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-purple-50 rounded-lg hover:bg-purple-100 text-purple-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"></path></svg>
                    Histologie Endspurt
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                    Stundenplan (Bild)
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-yellow-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Med. Psychologie - Plan
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Physio - Seminarinhalte
                </a>
            </li>
             <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Physio - Seminar Zeitplan
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-orange-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Anorganische Chemie (AC) Skript
                </a>
            </li>
        </ul>
    </div>
    <!-- Ende Ressourcen-Men√º -->


    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Dein Med-Lernplan WS 25/26 (V20)</h1>
                    <p class="text-lg text-gray-600">W√∂chentliche Sprints (statt Phasen).</p>
                </div>
                <div class="text-left md:text-right mt-4 md:mt-0 flex items-center">
                    <div class="mr-6">
                        <span id="current-date" class="text-sm font-semibold text-blue-700">Lade Datum...</span><br>
                        <span id="save-status" class="text-sm text-gray-500">Bereit</span>
                    </div>
                    <!-- NEU V17: Burger Men√º Button -->
                    <button id="open-menu-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Globaler Fortschrittsbalken -->
            <div class="mt-8">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-blue-700">Gesamtfortschritt</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

        </header>

        <!-- Container f√ºr die Lernphasen -->
        <div class="space-y-8" id="plan-container">
            <!-- Alle Phasen-Sektionen werden hier dynamisch von JS eingef√ºgt -->
        </div>
    </div>

    <!-- Lokales Speicher-Skript (V20 - W√∂chentliche Sprints) -->
    <script type="module">
        
        // --- Globale Variablen ---
        let debounceTimer; // F√ºr verz√∂gertes Speichern
        const statusElement = document.getElementById('save-status');
        const LOCAL_STORAGE_KEY = 'meinMedizinLernplan_V20'; // Neuer Key f√ºr V20
        const planContainer = document.getElementById('plan-container');
        const currentDateElement = document.getElementById('current-date');
        const globalProgressBar = document.getElementById('progress-bar');
        const globalProgressText = document.getElementById('progress-text');
        
        // --- V17: Men√º-Variablen ---
        const menu = document.getElementById('resource-menu');
        const overlay = document.getElementById('menu-overlay');
        const openBtn = document.getElementById('open-menu-btn');
        const closeBtn = document.getElementById('close-menu-btn');

        // Simuliertes heutiges Datum f√ºr Tests (z.B. '2025-11-06T12:00:00')
        const now = new Date('2025-11-06T12:00:00'); // Test: KW 45 aktiv
        // const now = new Date(); // Echtes Datum verwenden
        // const now = new Date('2025-12-10T12:00:00'); // Test: KW 50 aktiv
        
        // --- Phasen-Zeit-Metadaten (W√∂chentliche Struktur) ---
        const phaseMetadata = {
            kw45: { name: "KW 45: Aktueller Fokus", startDate: new Date('2025-11-03'), endDate: new Date('2025-11-09T23:59:59'), color: "blue" },
            kw46: { name: "KW 46: Histo-Catchup", startDate: new Date('2025-11-10'), endDate: new Date('2025-11-16T23:59:59'), color: "gray" },
            kw47: { name: "KW 47: Urlaub & Weibl. Gen. I", startDate: new Date('2025-11-17'), endDate: new Date('2025-11-23T23:59:59'), color: "gray" },
            kw48: { name: "KW 48: Histo-Catchup II & Psycho-Start", startDate: new Date('2025-11-24'), endDate: new Date('2025-11-30T23:59:59'), color: "gray" },
            kw49: { name: "KW 49: Histo Niere & Ana 3", startDate: new Date('2025-12-01'), endDate: new Date('2025-12-07T23:59:59'), color: "gray" },
            kw50: { name: "KW 50: Klausur Med. Psychologie", startDate: new Date('2025-12-08'), endDate: new Date('2025-12-14T23:59:59'), color: "yellow" },
            kw51: { name: "KW 51: Klausur Histologie II", startDate: new Date('2025-12-15'), endDate: new Date('2025-12-21T23:59:59'), color: "purple" },
            kw52: { name: "KW 52: Weihnachtspause & Ana 2", startDate: new Date('2025-12-22'), endDate: new Date('2025-12-28T23:59:59'), color: "gray" },
            kw01: { name: "KW 1 '26: Ana 2 & AC", startDate: new Date('2025-12-29'), endDate: new Date('2026-01-04T23:59:59'), color: "gray" },
            kw02: { name: "KW 2: Biochemie-Praktikum & Ana 2", startDate: new Date('2026-01-05'), endDate: new Date('2026-01-11T23:59:59'), color: "green" },
            kw03: { name: "KW 3: Ana 3 & Testat-Vorb.", startDate: new Date('2026-01-12'), endDate: new Date('2026-01-18T23:59:59'), color: "gray" },
            kw04: { name: "KW 4: Klausur Ganzk√∂rpertestat", startDate: new Date('2026-01-19'), endDate: new Date('2026-01-25T23:59:59'), color: "red" },
            kw05: { name: "KW 5: Finale AC & BC/Termi", startDate: new Date('2026-01-26'), endDate: new Date('2026-02-01T23:59:59'), color: "gray" },
            kw06: { name: "KW 6: KLAUSURENWOCHE", startDate: new Date('2026-02-02'), endDate: new Date('2026-02-08T23:59:59'), color: "red" },
            kw_future: { name: "Langfristige Ziele (Ab KW 7 '26)", startDate: new Date('2026-02-09'), endDate: new Date('2026-04-30T23:59:59'), color: "gray" }
        };

        // --- Standard-Datenstruktur (V20 - W√∂chentlich) ---
        const defaultData = {
            kw45: {
                goals: [ { id: 'goal-kw45-1', text: '<strong>Physio-Test (07.11.)</strong> bestehen', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' } ],
                tasks: [
                    { id: 'task-kw45-1', text: 'Physio-Seminar WS 4: "Blut I" (alle 3 Themen)', checked: false, style: '' },
                    { id: 'task-kw45-2', text: 'AC-Selbststudium: PDF sichten & Lernplan-Bl√∂cke verstehen', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-kw45-3', text: 'Histo: Vorlesung 06.11. (Leber II) besuchen/nacharbeiten', checked: false, style: 'font-semibold text-purple-700' }
                ]
            },
            kw46: {
                goals: [ { id: 'goal-kw46-1', text: '<strong>Physio-Test (14.11.)</strong> bestehen', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                         { id: 'goal-kw46-2', text: '<strong>Histo-Notfallplan</strong> starten', style: 'p-4 bg-red-50 rounded-lg text-red-800' } ],
                tasks: [
                    { id: 'task-kw46-1', text: 'Histo CATCH-UP: 1. Immunologie & Lymph. Organe (VL 13.10-21.10)', checked: false, style: 'font-bold text-red-700 bg-red-50' },
                    { id: 'task-kw46-2', text: 'Histo: 4. Endokrines System (VL 11.11-13.11) besuchen/lernen', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw46-3', text: 'Physio Test (14.11.): Blut II (H√§mostase, Immunologie)', checked: false, style: '' },
                    { id: 'task-kw46-4', text: 'Ana 1 - Lerntag 1: Allg. Ana/Embryo, Obere Extremit√§t (Knochen, Gelenke)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw46-5', text: 'AC-Block A: Grundlagen, Formeln, S√§ure/Base (pdf S. 1-3, 16-22, 44-46)', checked: false, style: 'font-semibold text-orange-700' }
                ]
            },
            kw47: {
                goals: [ { id: 'goal-kw47-1', text: '<strong>Urlaub (19.11. - 21.11.)</strong>', style: 'p-4 bg-teal-50 rounded-lg text-teal-800' } ],
                tasks: [
                    { id: 'task-kw47-1', text: 'Histo: 5. Weibl. Genitale I (VL 17.11-18.11) VOR dem Urlaub lernen!', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw47-2', text: 'Blocker: URLAUB (19.11. - 21.11.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' }
                ]
            },
            kw48: {
                goals: [ { id: 'goal-kw48-1', text: '<strong>Psycho-Lernphase</strong> starten', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' },
                         { id: 'goal-kw48-2', text: '<strong>Physio-Test (28.11.)</strong> bestehen', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' } ],
                tasks: [
                    { id: 'task-kw48-1', text: 'NACHHOLEN: Physio-Stoff "Energiehaushalt" (von KW 47)', checked: false, style: 'font-semibold text-gray-500' },
                    { id: 'task-kw48-2', text: 'NACHHOLEN: Histo: 5. Weibl. Genitale II (VL 19.11-24.11)', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw48-3', text: 'Ab 25.11.: Intensiv-Lernphase Med. Psychologie starten', checked: false, style: 'font-bold text-yellow-800' },
                    { id: 'task-kw48-4', text: 'Histo: 6. M√§nnl. Genitale (VL 25.11-01.12) besuchen/lernen', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw48-5', text: 'Physio Test (28.11.): Atmung I', checked: false, style: '' },
                    { id: 'task-kw48-6', text: 'Ana 1 - Lerntag 2: Obere Extremit√§t (Muskeln, Leitungsbahnen, Topo)', checked: false, style: 'font-semibold text-red-700' }
                ]
            },
            kw49: {
                goals: [ { id: 'goal-kw49-1', text: '<strong>Physio-Test (05.12.)</strong> bestehen', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' } ],
                tasks: [
                    { id: 'task-kw49-1', text: 'Histo: 7. Niere & Abl. Harnwege (VL 02.12-04.12)', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw49-2', text: 'AC-Block B: Redox-Reaktionen & Nernst (pdf S. 1, 23-34)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-kw49-3', text: 'Physio Test (05.12.): Atmung II', checked: false, style: '' },
                    { id: 'task-kw49-4', text: 'Ana 1 - Lerntag 3: Untere Extremit√§t (Knochen, Gelenke, Muskeln, Topo)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw49-5', text: 'Histo CATCH-UP: 3. Verdauung (Z√§hne... Magen) (VL 22.10-30.10)', checked: false, style: 'font-bold text-red-700 bg-red-50' }
                ]
            },
            kw50: {
                goals: [ { id: 'goal-kw50-1', text: '<strong>KLAUSUR: Med. Psychologie (09.12.)</strong>', style: 'p-4 bg-yellow-100 rounded-lg text-yellow-900 border border-yellow-300 font-bold' },
                         { id: 'goal-kw50-2', text: '<strong>Physio-Test (12.12.)</strong> bestehen', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' } ],
                tasks: [
                    { id: 'task-kw50-1', text: 'FINALE LERNPHASE MED. PSYCHOLOGIE (07.12. - 08.12.)', checked: false, style: 'font-bold text-yellow-800 bg-yellow-50' },
                    { id: 'task-kw50-2', text: 'Histo: 7. Niere & Abl. Harnwege (VL 08.12-10.12) besuchen/lernen', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw50-3', text: 'Physio Test (12.12.): Niere I', checked: false, style: '' }
                ]
            },
            kw51: {
                goals: [ { id: 'goal-kw51-1', text: '<strong>KLAUSUR: Histologie II (16.12.)</strong>', style: 'p-4 bg-purple-100 rounded-lg text-purple-900 border border-purple-300 font-bold' },
                         { id: 'goal-kw51-2', text: '<strong>Letzter Physio-Test (19.12.)</strong>', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' } ],
                tasks: [
                    { id: 'task-kw51-1', text: 'FINALE LERNPHASE HISTOLOGIE (Alle Histo II Themen) (13.12. - 15.12.)', checked: false, style: 'font-bold text-purple-800 bg-purple-50' },
                    { id: 'task-kw51-2', text: 'Ana 1 - Lerntag 4: R√ºcken, Brust-, Bauchwand, Beckenboden', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw51-3', text: 'Physio Test (19.12.): Elektrolyt-/S√§ure-Basen', checked: false, style: '' }
                ]
            },
            kw52: {
                goals: [ { id: 'goal-kw52-1', text: '<strong>WEIHNACHTSPAUSE</strong>', style: 'p-4 bg-teal-50 rounded-lg text-teal-800 font-medium' } ],
                tasks: [
                    { id: 'task-kw52-1', text: 'Blocker: WEIHNACHTSPAUSE (21.12. - 26.12.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' },
                    { id: 'task-kw52-2', text: 'Ana 2 - Lernpaket 5: Brustsitus (Herz, Lunge, √ñsophagus)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw52-3', text: 'AC-Block C: Thermodynamik & Kinetik (pdf S. 2, 3, 11-15)', checked: false, style: 'font-semibold text-orange-700' }
                ]
            },
            kw01: {
                goals: [ { id: 'goal-kw01-1', text: 'Ana 2 (Eingeweide) & BC-Praktikum vorbereiten', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' } ],
                tasks: [
                    { id: 'task-kw01-1', text: 'Ana 2 - Lernpaket 6: Bauchsitus (Magen, Darm, Leber, Pankreas)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw01-2', text: 'Vor 07.01.: √úberblick Biochemie-Praktikumsthemen', checked: false, style: '' }
                ]
            },
            kw02: {
                goals: [ { id: 'goal-kw02-1', text: '<strong>Start Biochemie Praktikum (07.01.)</strong>', style: 'p-4 bg-green-50 rounded-lg text-green-800 font-medium' } ],
                tasks: [
                    { id: 'task-kw02-1', text: 'Biochemie-Praktikum (ab 07.01.) t√§glich vor/nachbereiten', checked: false, style: 'font-semibold text-green-700' },
                    { id: 'task-kw02-2', text: 'Ana 2 - Lernpaket 7 & 8: Beckensitus, Geschlechtsorgane, Leitungsbahnen', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw02-3', text: 'AC-Block D: Atomtheorie, PSE, Trends (pdf S. 4-6)', checked: false, style: 'font-semibold text-orange-700' }
                ]
            },
            kw03: {
                goals: [ { id: 'goal-kw03-1', text: '<strong>FINALE: Ganzk√∂rpertestat (20.01.)</strong>', style: 'p-4 bg-red-100 rounded-lg text-red-900 border border-red-300 font-bold' } ],
                tasks: [
                    { id: 'task-kw03-1', text: 'Ana 3 - Lernpaket 9 & 10: Kopf & Hals', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw03-2', text: 'Ana 3 - Lernpaket 11 & 12: ZNS, Sinnesorgane', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-kw03-3', text: 'Biochemie-Praktikum weiterf√ºhren', checked: false, style: 'font-semibold text-green-700' }
                ]
            },
            kw04: {
                goals: [ { id: 'goal-kw04-1', text: '<strong>TESTAT-WOCHE</strong>', style: 'p-4 bg-red-100 rounded-lg text-red-900 border border-red-300 font-bold' } ],
                tasks: [
                    { id: 'task-kw04-1', text: 'Ana-Block 7: Puffer & Finale Repetition (Ana 1, 2, 3) (19.01. - 20.01.)', checked: false, style: 'font-bold text-red-900' },
                    { id: 'task-kw04-2', text: 'Ab 21.01.: Fokus auf Biochemie (Nachbereitung Praktikum) & Termi', checked: false, style: '' },
                    { id: 'task-kw04-3', text: 'Biochemie-Praktikum weiterf√ºhren', checked: false, style: 'font-semibold text-green-700' }
                ]
            },
            kw05: {
                goals: [ { id: 'goal-kw05-1', text: 'Vorbereitung Klausurenwoche', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' } ],
                tasks: [
                    { id: 'task-kw05-1', text: 'Biochemie-Praktikum abschlie√üen (bis 30.01.)', checked: false, style: 'font-semibold text-green-700' },
                    { id: 'task-kw05-2', text: 'Terminologie Vokabeln lernen', checked: false, style: '' },
                    { id: 'task-kw05-3', text: 'AC-Block E: Bindungstypen, Lewis, VSEPR (pdf S. 6-10)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-kw05-4', text: 'AC-Block F: Komplexe & Nomenklatur (pdf S. 35-43)', checked: false, style: 'font-semibold text-orange-700' }
                ]
            },
            kw06: {
                goals: [
                    { id: 'goal-kw06-histo', text: '<strong>Histo-Nachklausur (02.02.)</strong>', style: 'p-4 bg-purple-50 rounded-lg text-purple-800' },
                    { id: 'goal-kw06-bc', text: '<strong>Biochemie (04.02.)</strong>', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal-kw06-termi', text: '<strong>Terminologie (04.02.)</strong>', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal-kw06-bio', text: '<strong>Biologie (06.02.)</strong>', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal-kw06-ac', text: '<strong>Chemie (AC) (07.02.)</strong>', style: 'p-4 bg-orange-100 rounded-lg text-orange-900 border border-orange-300' }
                ],
                tasks: [
                    { id: 'task-kw06-1', text: 'Histo: Ggf. Nachklausur (02.02.26) vorbereiten', checked: false, style: 'font-semibold text-purple-700' },
                    { id: 'task-kw06-2', text: 'Finale Lernphase BC & Termi', checked: false, style: '' },
                    { id: 'task-kw06-3', text: '04.02. & 05.02.: Fokus auf Biologie f√ºr Mediziner', checked: false, style: '' },
                    { id: 'task-kw06-4', text: 'AC-Block G: Finale Altklausuren & Formeln (pdf S. 1-3)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-kw06-5', text: '06.02.: AC-Klausurvorbereitung (letzter Tag)', checked: false, style: 'font-bold text-orange-900' }
                ]
            },
            kw_future: {
                goals: [
                    { id: 'goal-future-1', text: '<strong>Physiologie Praktikum:</strong> 11.03. - 02.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                    { id: 'goal-future-2', text: '<strong>Klausur Physiologie:</strong> 09.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800 font-medium' },
                    { id: 'goal-future-3', text: '<strong>Klausur Chemie (OC):</strong> April 2026 (TBD)', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' }
                ],
                tasks: [
                    { id: 'task-future-1', text: 'Nach Feb-Klausuren: Pause machen!', checked: false, style: '' },
                    { id: 'task-future-2', text: 'Ab Ende Feb.: Physiologie-Stoff der Wochentests reaktivieren', checked: false, style: '' },
                    { id: 'task-future-3', text: 'Physiologie-Praktikum (M√§rz) intensiv nutzen', checked: false, style: '' },
                    { id: 'task-future-4', text: 'Lernplan f√ºr OC-Klausur erstellen', checked: false, style: '' }
                ]
            }
        };

        // Der aktuelle Status der Daten
        let dataState;

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            currentDateElement.textContent = `Heute: ${now.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            setupMenuListeners();
            loadStateFromLocalStorage();
            createPhaseSections(); // Phasen-HTML dynamisch erstellen
            setupGlobalEventListeners();
            renderAllPhases();
            updateOverallProgress();
            highlightPhaseStatus();
            updateAllPhaseProgressBars();
        });
        
        // --- V17: Men√º-Funktionen ---
        function setupMenuListeners() {
            openBtn.addEventListener('click', () => {
                menu.classList.remove('menu-hidden');
                overlay.classList.remove('hidden');
            });
            closeBtn.addEventListener('click', closeMenu);
            overlay.addEventListener('click', closeMenu);
        }
        
        function closeMenu() {
            menu.classList.add('menu-hidden');
            overlay.classList.add('hidden');
        }

        // --- V20: Phasen-HTML dynamisch erstellen ---
        function createPhaseSections() {
            planContainer.innerHTML = ''; // Container leeren
            
            Object.keys(phaseMetadata).forEach(phaseKey => {
                const phase = phaseMetadata[phaseKey];
                
                // Farbschema basierend auf 'color'
                let colors = {
                    text: 'text-gray-800',
                    border: 'border-gray-200',
                    addBtn: 'bg-gray-700 hover:bg-gray-800',
                    focusRing: 'focus:ring-gray-300'
                };
                if (phase.color === 'blue') {
                    colors = { text: 'text-blue-700', border: 'border-blue-200', addBtn: 'bg-blue-500 hover:bg-blue-600', focusRing: 'focus:ring-blue-300' };
                } else if (phase.color === 'red') {
                    colors = { text: 'text-red-700', border: 'border-red-300', addBtn: 'bg-red-500 hover:bg-red-600', focusRing: 'focus:ring-red-300' };
                } else if (phase.color === 'yellow') {
                    colors = { text: 'text-yellow-700', border: 'border-yellow-300', addBtn: 'bg-yellow-500 hover:bg-yellow-600', focusRing: 'focus:ring-yellow-300' };
                } else if (phase.color === 'purple') {
                    colors = { text: 'text-purple-700', border: 'border-purple-300', addBtn: 'bg-purple-500 hover:bg-purple-600', focusRing: 'focus:ring-purple-300' };
                } else if (phase.color === 'green') {
                    colors = { text: 'text-green-700', border: 'border-green-300', addBtn: 'bg-green-500 hover:bg-green-600', focusRing: 'focus:ring-green-300' };
                }
                
                const section = document.createElement('section');
                section.id = `${phaseKey}-section`;
                section.className = `bg-white p-6 rounded-xl shadow-lg ${colors.border}`;
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold ${colors.text} mb-4">
                        <span id="${phaseKey}-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                        ${phase.name}
                    </h2>
                    <!-- Individueller Fortschrittsbalken -->
                    <div class="mt-2 mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                            <span id="${phaseKey}-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="${phaseKey}-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Ziele (Links) -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-goal-input-${phaseKey}" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 ${colors.focusRing}">
                                <button data-phase="${phaseKey}" data-type="goals" class="add-btn ${colors.addBtn} text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                            </div>
                            <ul class="space-y-3 goal-list" id="${phaseKey}-goals">
                                <!-- JS f√ºgt Ziele hier ein -->
                            </ul>
                        </div>
                        <!-- Tracking (Rechts) -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="new-task-input-${phaseKey}" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 ${colors.focusRing}">
                                <button data-phase="${phaseKey}" data-type="tasks" class="add-btn ${colors.addBtn} text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                            </div>
                            <ul class="space-y-2 task-list" id="${phaseKey}-tasks">
                                <!-- JS f√ºgt Tasks hier ein -->
                            </ul>
                        </div>
                    </div>
                `;
                planContainer.appendChild(section);
            });
        }


        // --- Globale Event-Listener (Event Delegation) ---
        function setupGlobalEventListeners() {
            planContainer.addEventListener('click', (e) => {
                const target = e.target;
                const parent = e.target.closest('span, input, button'); 
                if (!parent) return;

                if (parent.classList.contains('add-btn')) {
                    const phase = parent.dataset.phase;
                    const type = parent.dataset.type; 
                    const input = document.getElementById(`new-${type.slice(0, -1)}-input-${phase}`);
                    if (input && input.value.trim()) {
                        addItem(phase, type, input.value.trim());
                        input.value = ''; 
                    }
                }

                if (parent.classList.contains('delete-btn')) {
                    const { phase, type, id } = parent.dataset;
                    deleteItem(phase, type, id);
                }
                
                if (parent.classList.contains('learn-btn')) {
                    const { text } = parent.dataset;
                    const encodedText = encodeURIComponent(text);
                    window.open(`https://next.amboss.com/de/search?q=${encodedText}`, '_blank');
                }

                if (parent.matches('input[type="checkbox"]')) {
                    const { phase, id } = parent.dataset;
                    toggleTask(phase, id, parent.checked);
                }
                
                if (parent.classList.contains('edit-span') && !parent.isContentEditable) {
                    startEditing(parent);
                }
            });
        }
        
        // --- Editier-Logik ---
        function startEditing(span) {
            if (span.dataset.editing === 'true') return;
            span.dataset.editing = 'true';
            
            const { phase, type, id } = span.dataset;
            const originalHtml = span.innerHTML;
            const originalText = span.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editing-input';
            input.value = originalText;

            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();

            const save = () => {
                const newText = input.value.trim() || originalText;
                const item = dataState[phase][type].find(i => i.id === id);
                if (item) {
                    if (originalHtml.includes('<strong>')) {
                         item.text = `<strong>${newText.replace(/<\/?strong>/g, '')}</strong>`;
                    } else if (originalHtml.includes('<br>')) {
                         item.text = newText.replace(/\n/g, '<br>');
                    }
                    else {
                         item.text = newText;
                    }
                    saveStateToLocalStorage();
                }
                span.innerHTML = item ? item.text : originalHtml;
                span.dataset.editing = 'false';
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    save();
                } else if (e.key === 'Escape') {
                    span.innerHTML = originalHtml;
                    span.dataset.editing = 'false';
                }
            });
        }

        // --- Alle Phasen auf der UI rendern ---
        function renderAllPhases() {
            Object.keys(dataState).forEach(phase => {
                renderPhase(phase, 'goals');
                renderPhase(phase, 'tasks');
            });
        }

        // --- Eine einzelne Liste (Ziele oder Tasks) rendern ---
        function renderPhase(phase, type) { // type is 'goals' or 'tasks'
            const listElement = document.getElementById(`${phase}-${type}`);
            if (!listElement) return; 
            listElement.innerHTML = ''; 

            if (!dataState[phase] || !dataState[phase][type]) return;

            dataState[phase][type].forEach(item => {
                let li;
                if (type === 'goals') {
                    li = createGoalElement(item, phase);
                } else {
                    li = createTaskElement(item, phase);
                }
                listElement.appendChild(li);
            });
        }
        
        // --- HTML f√ºr ein Ziel-Element erstellen ---
        function createGoalElement(goal, phase) {
            const li = document.createElement('li');
            li.className = `goal-item flex justify-between items-center ${goal.style || 'p-4 bg-gray-50 rounded-lg text-gray-800'}`;
            li.innerHTML = `
                <span class="learn-btn" data-text="${goal.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">üìö</span>
                <span class="edit-span flex-grow" data-phase="${phase}" data-type="goals" data-id="${goal.id}">${goal.text}</span>
                <span data-phase="${phase}" data-type="goals" data-id="${goal.id}" class="delete-btn" title="L√∂schen">X</span>
            `;
            return li;
        }

        // --- HTML f√ºr ein Task-Element erstellen ---
        function createTaskElement(task, phase) {
            const li = document.createElement('li');
            li.className = 'task-item flex justify-between items-center bg-gray-50 p-2 rounded-lg';
            
            const labelStyle = task.style || '';
            const disabled = task.disabled ? 'disabled' : '';

            li.innerHTML = `
                <div class="flex-grow flex items-center">
                    <input type="checkbox" id="${task.id}" data-phase="${phase}" data-id="${task.id}" ${task.checked ? 'checked' : ''} ${disabled} class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 flex-shrink-0">
                    <label for="${task.id}" class="ml-3 ${labelStyle} ${disabled ? 'text-gray-400' : 'text-gray-800'} w-full">
                         <span class="edit-span" data-phase="${phase}" data-type="tasks" data-id="${task.id}">${task.text}</span>
                    </label>
                </div>
                <span class="learn-btn" data-text="${task.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">üìö</span>
                ${!disabled ? `<span data-phase="${phase}" data-type="tasks" data-id="${task.id}" class="delete-btn" title="L√∂schen">X</span>` : ''}
            `;
            return li;
        }

        // --- CRUD-Logik-Funktionen ---
        function addItem(phase, type, text) {
            const newItem = {
                id: `item-${Date.now()}`,
                text: text,
                style: (type === 'goals') ? 'p-4 bg-gray-50 rounded-lg text-gray-800' : '',
                checked: false,
                custom: true
            };
            dataState[phase][type].push(newItem);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        function toggleTask(phase, taskId, isChecked) {
            const task = dataState[phase].tasks.find(t => t.id === taskId);
            if (task) {
                task.checked = isChecked;
                saveStateToLocalStorage();
            }
        }

        function deleteItem(phase, type, id) {
            dataState[phase][type] = dataState[phase][type].filter(item => item.id !== id);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        // --- Daten von localStorage laden ---
        function loadStateFromLocalStorage() {
            statusElement.textContent = "Lade...";
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            
            if (savedState) {
                dataState = JSON.parse(savedState);
                // Stelle sicher, dass alle Phasen/Typen existieren
                Object.keys(defaultData).forEach(phase => {
                    if (!dataState[phase]) {
                        dataState[phase] = defaultData[phase];
                    } else {
                        if (!dataState[phase].goals) dataState[phase].goals = defaultData[phase].goals;
                        if (!dataState[phase].tasks) dataState[phase].tasks = defaultData[phase].tasks;
                    }
                });
            } else {
                dataState = JSON.parse(JSON.stringify(defaultData)); // Tiefe Kopie
            }
            statusElement.textContent = "Bereit";
        }

        // --- Daten in localStorage speichern (mit Debounce) ---
        function saveStateToLocalStorage() {
            clearTimeout(debounceTimer);
            statusElement.textContent = "Speichere...";
            statusElement.classList.add('syncing');
            
            debounceTimer = setTimeout(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataState));
                    statusElement.textContent = "Lokal gespeichert";
                    updateOverallProgress(); 
                    highlightPhaseStatus(); 
                    updateAllPhaseProgressBars();
                } catch (error) {
                    console.error("Fehler beim Speichern in localStorage:", error);
                    statusElement.textContent = "Speicherfehler!";
                } finally {
                    statusElement.classList.remove('syncing');
                }
            }, 1000); 
        }
        
        // --- Fortschritt & Status Updates ---
        function updateOverallProgress() {
            let totalTasks = 0;
            let checkedTasks = 0;
            
            Object.keys(dataState).forEach(phase => {
                dataState[phase].tasks.forEach(task => {
                    if (!task.disabled) { 
                        totalTasks++;
                        if (task.checked) {
                            checkedTasks++;
                        }
                    }
                });
            });
            
            const percentage = (totalTasks === 0) ? 0 : Math.round((checkedTasks / totalTasks) * 100);
            
            globalProgressBar.style.width = `${percentage}%`;
            globalProgressText.textContent = `${percentage}% (${checkedTasks}/${totalTasks})`;
        }

        function updatePhaseProgress(phase) {
            if (!dataState[phase] || !dataState[phase].tasks) return;
            
            let totalTasks = 0;
            let checkedTasks = 0;
            dataState[phase].tasks.forEach(task => {
                if (!task.disabled) {
                    totalTasks++;
                    if (task.checked) {
                        checkedTasks++;
                    }
                }
            });

            const percentage = (totalTasks === 0) ? 100 : Math.round((checkedTasks / totalTasks) * 100);
            const bar = document.getElementById(`${phase}-progress-bar`);
            const text = document.getElementById(`${phase}-progress-text`);

            if (bar) bar.style.width = `${percentage}%`;
            if (text) text.textContent = `${percentage}% (${checkedTasks}/${totalTasks})`;

            if (bar) {
                bar.classList.remove('bg-gray-600', 'bg-blue-600', 'bg-green-500', 'bg-red-600');
                const statusIcon = document.getElementById(`${phase}-status`);
                
                if (percentage === 100) {
                    bar.classList.add('bg-green-500'); // Erledigt
                } else if (statusIcon && statusIcon.classList.contains('bg-red-500')) {
                    bar.classList.add('bg-red-600'); // √úberf√§llig
                } else if (statusIcon && statusIcon.classList.contains('bg-blue-500')) {
                    bar.classList.add('bg-blue-600'); // Aktiv
                } else {
                    bar.classList.add('bg-gray-600'); // Zuk√ºnftig
                }
            }
        }

        function updateAllPhaseProgressBars() {
            Object.keys(dataState).forEach(phase => {
                updatePhaseProgress(phase);
            });
        }
        
        function highlightPhaseStatus() {
            Object.keys(phaseMetadata).forEach(phase => {
                const meta = phaseMetadata[phase];
                const phaseData = dataState[phase];
                const icon = document.getElementById(`${phase}-status`);
                const section = document.getElementById(`${phase}-section`);
                
                if (!icon || !section || !phaseData) {
                    return;
                }

                icon.className = 'phase-status-icon';
                section.style.border = 'none';

                const openTasks = phaseData.tasks.some(task => !task.checked && !task.disabled);
                if (!openTasks) {
                    icon.classList.add('bg-green-500'); // Gr√ºn: Erledigt
                    icon.title = "Erledigt";
                    section.style.borderColor = '#22c55e'; // green-500
                    return;
                }
                
                if (now >= meta.startDate && now <= meta.endDate) {
                    icon.classList.add('bg-blue-500'); // Blau: Aktiv
                    icon.title = "Aktive Phase";
                    section.style.border = '2px solid #3b82f6'; // blue-500
                } else if (now > meta.endDate && openTasks) {
                    icon.classList.add('bg-red-500'); // Rot: √úberf√§llig
                    icon.title = "√úberf√§llig (Aufgaben offen)";
                    section.style.border = '2px solid #ef4444'; // red-500
                } else if (now < meta.startDate) {
                    icon.classList.add('bg-gray-300'); // Grau: Zuk√ºnftig
                    icon.title = "Zuk√ºnftig";
                } else {
                     icon.classList.add('bg-gray-300'); // Grau: Vergangen (aber erledigt)
                    icon.title = "Vergangen";
                }
            });
        }

    </script>
</body>
</html>
