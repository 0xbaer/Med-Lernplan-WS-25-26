<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Medi-Lernplan WS 25/26 (V18 - Endspurt-Integration)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Verhindert horizontales Scrollen beim Öffnen des Menüs */
        }
        /* Stil für abgehakte Aufgaben */
        .task-item input:checked + label .edit-span {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .task-item label, .goal-item .edit-span {
            transition: color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-block; /* Wichtig für Klickbarkeit */
            width: 100%;
        }
        /* Hover-Effekt für editierbare Texte */
        .goal-item .edit-span:hover, .task-item label .edit-span:hover {
            background-color: #eff6ff; /* blue-50 */
            border-radius: 3px;
            box-shadow: 0 0 0 1px #dbeafe; /* blue-100 */
        }
        /* Speicher-Animation */
        #save-status.syncing::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' '; }
        }
        /* Löschen-Button (rotes X) */
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            font-weight: bold;
            padding: 0 4px;
            font-family: monospace;
            color: #ef4444; /* red-500 */
            align-self: flex-start;
        }
        /* "Lernen"-Button (Buch) */
        .learn-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            padding: 0 6px;
            align-self: flex-start;
        }
        .task-item:hover .delete-btn, .goal-item:hover .delete-btn,
        .task-item:hover .learn-btn, .goal-item:hover .learn-btn {
            opacity: 1;
        }
        /* Eingabefeld, das beim Editieren erscheint */
        .editing-input {
            width: 95%;
            padding: 2px 4px;
            border: 1px solid #3b82f6; /* blue-500 */
            border-radius: 3px;
            outline: none;
            font: inherit;
        }
        .phase-status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
        /* --- NEU V17: Slide-Over Menü --- */
        #resource-menu {
            transition: transform 0.3s ease-in-out;
        }
        #menu-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .menu-hidden {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="h-full p-4 md:p-8 bg-gray-100">

    <!-- NEU V17: Overlay für Menü -->
    <div id="menu-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-30 hidden"></div>

    <!-- NEU V17: Ressourcen-Menü (Slide-Over) -->
    <!-- HINWEIS V18: Links für Anatomie & Histo Skripte hinzugefügt -->
    <div id="resource-menu" class="fixed top-0 right-0 h-full w-80 bg-white shadow-xl z-40 p-6 menu-hidden overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-gray-900">Ressourcen</h2>
            <button id="close-menu-btn" class="text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <p class="text-sm text-gray-600 mb-4">
            <!-- HINWEIS: Ersetze die 'href' #" Platzhalter unten mit deinen echten Google Drive / Cloud-Links -->
        </p>
        
        <ul class="space-y-3">
            <!-- Anatomie Skripte -->
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5M8.25 6.253l-3 3m3-3l3 3M6.253 18v-3.375c0-1.02.84-1.875 1.875-1.875h7.75c1.035 0 1.875.855 1.875 1.875V18M17.75 6.253l-3 3m3-3l3 3"></path></svg>
                    Anatomie 1: Allg./Extrem.
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.5 12.75l6 6 9-13.5"></path></svg>
                    Anatomie 2: Eingeweide
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-red-50 rounded-lg hover:bg-red-100 text-red-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Anatomie 3: Kopf, Hals, ZNS
                </a>
            </li>
            <!-- Histo Skript -->
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-purple-50 rounded-lg hover:bg-purple-100 text-purple-700 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"></path></svg>
                    Histologie Endspurt
                </a>
            </li>
            <!-- Andere Dokumente -->
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                    Stundenplan (Bild)
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-yellow-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Med. Psychologie - Plan
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Physio - Seminarinhalte
                </a>
            </li>
             <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-blue-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Physio - Seminar Zeitplan
                </a>
            </li>
            <li>
                <a href="#" target="_blank" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-orange-600 font-medium">
                    <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Anorganische Chemie (AC) Skript
                </a>
            </li>
        </ul>
    </div>
    <!-- Ende Ressourcen-Menü -->


    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Dein Med-Lernplan WS 25/26 (V18)</h1>
                    <p class="text-lg text-gray-600">Integriert mit Endspurt-Lerntagen.</p>
                </div>
                <div class="text-left md:text-right mt-4 md:mt-0 flex items-center">
                    <div class="mr-6">
                        <span id="current-date" class="text-sm font-semibold text-blue-700">Lade Datum...</span><br>
                        <span id="save-status" class="text-sm text-gray-500">Bereit</span>
                    </div>
                    <!-- NEU V17: Burger Menü Button -->
                    <button id="open-menu-btn" class="p-2 rounded-lg text-gray-600 hover:bg-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Globaler Fortschrittsbalken -->
            <div class="mt-8">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-blue-700">Gesamtfortschritt</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

        </header>

        <!-- Container für die Lernphasen -->
        <div class="space-y-8" id="plan-container">

            <!-- Phase 1: Aktueller Fokus -->
            <section id="phase1-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">
                    <span id="phase1-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 1: Aktueller Fokus (Bis 07.11.2025)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 1 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase1-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase1-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase1" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <button data-phase="phase1" data-type="goals" class="add-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase1-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase1" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <button data-phase="phase1" data-type="tasks" class="add-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase1-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- NEU: Phase 2 (November) -->
            <section id="phase2-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase2-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 2: Histo-Catchup & Ana 1 (08.11. - 01.12.2025)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 2 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase2-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase2-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase2" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase2" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase2-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase2" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase2" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase2-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- NEU: Phase 3 (Dezember-Klausuren) -->
            <section id="phase3-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase3-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 3: Dezember-Klausuren (02.12. - 20.12.2025)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 3 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase3-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase3-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Hauptziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase3" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase3" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                         <ul class="space-y-3 goal-list" id="phase3-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase3" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase3" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase3-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Umnummeriert: Phase 4 (Januar) -->
            <section id="phase4-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase4-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 4: Ana-Endspurt & Biochemie (21.12.2025 - 20.01.2026)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 4 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase4-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase4-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Hauptziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase4" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase4" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                         <ul class="space-y-3 goal-list" id="phase4-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase4" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase4" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase4-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Umnummeriert: Phase 5 (Februar-Klausuren) -->
            <section id="phase5-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-red-700 mb-4">
                    <span id="phase5-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 5: Februar-Klausuren (21.01. - 07.02.2026)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 5 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase5-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase5-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Alle Klausuren</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase5" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-300">
                            <button data-phase="phase5" data-type="goals" class="add-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase5-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase5" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-300">
                            <button data-phase="phase5" data-type="tasks" class="add-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase5-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Umnummeriert: Phase 6 (Langfristig) -->
            <section id="phase6-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase6-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 6: Langfristige Ziele (Frühjahr 2026)
                </h2>
                <!-- Individueller Fortschrittsbalken für Phase 6 -->
                <div class="mt-2 mb-4">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Phasen-Fortschritt</span>
                        <span id="phase6-progress-text" class="text-sm font-medium text-gray-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="phase6-progress-bar" class="bg-gray-600 h-2 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Zukünftige Prüfungen</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase6" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase6" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                         <ul class="space-y-3 goal-list" id="phase6-goals">
                            <!-- JS fügt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase6" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase6" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase6-tasks">
                            <!-- JS fügt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Lokales Speicher-Skript (V18 - Endspurt-Integration) -->
    <script type="module">
        
        // --- Globale Variablen ---
        let debounceTimer; // Für verzögertes Speichern
        const statusElement = document.getElementById('save-status');
        const LOCAL_STORAGE_KEY = 'meinMedizinLernplan_V18'; // Neuer Key für V18
        const planContainer = document.getElementById('plan-container');
        const currentDateElement = document.getElementById('current-date');
        const globalProgressBar = document.getElementById('progress-bar');
        const globalProgressText = document.getElementById('progress-text');
        
        // --- NEU V17: Menü-Variablen ---
        const menu = document.getElementById('resource-menu');
        const overlay = document.getElementById('menu-overlay');
        const openBtn = document.getElementById('open-menu-btn');
        const closeBtn = document.getElementById('close-menu-btn');

        // Simuliertes heutiges Datum für Tests (z.B. '2025-11-06T12:00:00')
        // const now = new Date('2025-11-06T12:00:00'); // Test: Phase 1 aktiv
        const now = new Date(); // Echtes Datum verwenden
        // const now = new Date('2025-12-10T12:00:00'); // Test: Phase 3 aktiv
        
        // --- Phasen-Zeit-Metadaten (6-Phasen-Struktur) ---
        const phaseMetadata = {
            phase1: { startDate: new Date('2025-10-01'), endDate: new Date('2025-11-07T23:59:59') },
            phase2: { startDate: new Date('2025-11-08'), endDate: new Date('2025-12-01T23:59:59') }, 
            phase3: { startDate: new Date('2025-12-02'), endDate: new Date('2025-12-20T23:59:59') }, 
            phase4: { startDate: new Date('2025-12-21'), endDate: new Date('2026-01-20T23:59:59') }, 
            phase5: { startDate: new Date('2026-01-21'), endDate: new Date('2026-02-07T23:59:59') }, 
            phase6: { startDate: new Date('2026-02-08'), endDate: new Date('2026-04-30T23:59:59') }
        };

        // --- Standard-Datenstruktur (V18 - 6-Phasen-Struktur mit Endspurt-Tasks) ---
        const defaultData = {
            phase1: { // Bis 07.11.
                goals: [
                    { id: 'goal1-1', text: '<strong>Testat:</strong> Wöchentlicher Physio-Test (07.11.)', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' }
                ],
                tasks: [
                    { id: 'task1-1', text: 'Physio-Seminar WS 4: "Blut I" (Zusammensetzung) lernen', checked: false, style: '' },
                    { id: 'task1-2', text: 'Physio-Seminar WS 4: "Erythrozyten & Anämien" verstehen', checked: false, style: '' },
                    { id: 'task1-3', text: 'Physio-Seminar WS 4: "Blutgruppen" wiederholen', checked: false, style: '' },
                    { id: 'task1-4', text: 'AC-Selbststudium: PDF sichten & Lernplan-Blöcke verstehen', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-histo-start', text: 'Histo-Notfallplan: Unterlagen sichten & Histo Skript "Lerntag 14: Zelle" beginnen', checked: false, style: 'font-semibold text-purple-700' }
                ]
            },
            phase2: { // 08.11. - 01.12.
                goals: [
                    { id: 'goal2-new-histo', text: '<strong>KLAUSUR: Histologie II (16.12.)</strong>', style: 'p-4 bg-purple-100 rounded-lg text-purple-900 border border-purple-300 font-bold' },
                    { id: 'goal2-5', text: '<strong>Klausur:</strong> Med. Psychologie (09.12.)', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' },
                    { id: 'goal2-1', text: '<strong>Ana 1:</strong> Lerntage 1-2 (Allg./Extrem.)', style: 'p-4 bg-red-50 rounded-lg text-red-800 font-medium' },
                    { id: 'goal2-new-ac', text: '<strong>Dauerlauf AC-Selbststudium</strong>', style: 'p-4 bg-orange-50 rounded-lg text-orange-800 font-medium' },
                    { id: 'goal2-3', text: '<strong>Dauerlauf:</strong> Wöchentliche Physio-Tests', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                    { id: 'goal2-4', text: '<strong>Physio-Ziel:</strong> 15 Pkt. aus 6 Tests (Schnitt: 2.5/6)', style: 'p-4 bg-blue-100 rounded-lg text-blue-900 border border-blue-300' },
                    { id: 'goal2-6', text: '<strong>Urlaub:</strong> 19.11. - 21.11. (Buenos Aires!)', style: 'p-4 bg-teal-50 rounded-lg text-teal-800' }
                ],
                tasks: [
                    { id: 'task-histo-14', text: 'Histo - Lerntag 14: Zelle', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task2-3', text: 'Physio Test (14.11.): Blut II (Hämostase, Immunologie)', checked: false, style: '' },
                    { id: 'task-histo-15', text: 'Histo - Lerntag 15: Gewebe', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task-ana-1', text: 'Ana 1 - Lerntag 1: Allg. Ana/Embryo, Obere Extremität (Knochen, Gelenke)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-ac-1', text: 'AC-Block A: Grundlagen, Formeln, Säure/Base (pdf S. 1-3, 16-22, 44-46)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-vacation', text: 'Blocker: URLAUB (19.11. - 21.11.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' },
                    { id: 'task2-4', text: 'NACHHOLEN (nach 21.11.): Physio-Stoff "Energiehaushalt"', checked: false, style: '' },
                    { id: 'task-histo-16', text: 'Histo - Lerntag 16: Nervengewebe, Herz-Kreislauf', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task2-6', text: 'Ab 25.11.: Intensiv-Lernphase Med. Psychologie starten', checked: false, style: 'font-bold text-yellow-800' },
                    { id: 'task2-7', text: 'Physio Test (28.11.): Atmung I', checked: false, style: '' },
                    { id: 'task-ana-2', text: 'Ana 1 - Lerntag 2: Obere Extremität (Muskeln, Leitungsbahnen, Topo)', checked: false, style: 'font-semibold text-red-700' }
                ]
            },
            phase3: { // 02.12. - 20.12.
                goals: [
                    { id: 'goal3-new-histo', text: '<strong>KLAUSUR: Histologie II (16.12.)</strong>', style: 'p-4 bg-purple-100 rounded-lg text-purple-900 border border-purple-300 font-bold' },
                    { id: 'goal3-5', text: '<strong>Klausur:</strong> Med. Psychologie (09.12.)', style: 'p-4 bg-yellow-100 rounded-lg text-yellow-900 border border-yellow-300 font-bold' },
                    { id: 'goal3-1', text: '<strong>Ana 1:</strong> Lerntage 3-4 (Untere Extrem., Rumpf)', style: 'p-4 bg-red-50 rounded-lg text-red-800 font-medium' },
                    { id: 'goal3-new-ac', text: '<strong>Dauerlauf AC-Selbststudium</strong>', style: 'p-4 bg-orange-50 rounded-lg text-orange-800 font-medium' },
                    { id: 'goal3-3', text: '<strong>Dauerlauf:</strong> Wöchentliche Physio-Tests', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' }
                ],
                tasks: [
                    { id: 'task-histo-17', text: 'Histo - Lerntag 17: Lymph. Gewebe, Atmung', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task-ac-2', text: 'AC-Block B: Redox-Reaktionen & Nernst (pdf S. 1, 23-34)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task3-8', text: 'Physio Test (05.12.): Atmung II', checked: false, style: '' },
                    { id: 'task-psycho-final', text: 'FINALE LERNPHASE MED. PSYCHOLOGIE (06.12. - 08.12.)', checked: false, style: 'font-bold text-yellow-800 bg-yellow-50' },
                    { id: 'task-ana-3', text: 'Ana 1 - Lerntag 3: Untere Extremität (Knochen, Gelenke, Muskeln, Topo)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-histo-18', text: 'Histo - Lerntag 18: Verdauung, Harnsystem', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task3-9', text: 'Physio Test (12.12.): Niere I', checked: false, style: '' },
                    { id: 'task-histo-19', text: 'Histo - Lerntag 19: Geschlechtsorgane, Haut, ZNS, Sinnesorg.', checked: false, style: 'font-bold text-purple-700 bg-purple-50' },
                    { id: 'task-histo-final', text: 'FINALE LERNPHASE HISTOLOGIE (13.12. - 15.12.)', checked: false, style: 'font-bold text-purple-800 bg-purple-50' },
                    { id: 'task-ana-4', text: 'Ana 1 - Lerntag 4: Rücken, Brust-, Bauchwand, Beckenboden', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task3-11', text: 'Physio Test (19.12.): Elektrolyt-/Säure-Basen', checked: false, style: '' }
                ]
            },
            phase4: { // 21.12. - 20.01.
                goals: [
                    { id: 'goal4-1', text: '<strong>WEIHNACHTSPAUSE:</strong> (21.12. - 26.12.)', style: 'p-4 bg-teal-50 rounded-lg text-teal-800 font-medium' },
                    { id: 'goal4-2', text: '<strong>Ana 2:</strong> Pakete 5-8 (Eingeweide)', style: 'p-4 bg-red-50 rounded-lg text-red-800' },
                    { id: 'goal4-3', text: '<strong>Ana 3:</strong> Pakete 9-12 (Kopf, Hals, ZNS)', style: 'p-4 bg-red-50 rounded-lg text-red-800' },
                    { id: 'goal4-4', text: '<strong>Start Biochemie Praktikum:</strong> 07.01.2026', style: 'p-4 bg-green-50 rounded-lg text-green-800 font-medium' },
                    { id: 'goal4-5', text: '<strong>FINALE: Ganzkörpertestat:</strong> 20.01.2026', style: 'p-4 bg-red-100 rounded-lg text-red-900 font-medium border border-red-300' }
                ],
                tasks: [
                    { id: 'task-xmas', text: 'Blocker: WEIHNACHTSPAUSE (21.12. - 26.12.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' },
                    { id: 'task-ana-5', text: 'Ana 2 - Lernpaket 5: Brustsitus (Herz, Lunge, Ösophagus)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-ac-3', text: 'AC-Block C: Thermodynamik & Kinetik (pdf S. 2, 3, 11-15)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-ana-6', text: 'Ana 2 - Lernpaket 6: Bauchsitus (Magen, Darm, Leber, Pankreas)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task4-2', text: 'Vor 07.01.: Überblick Biochemie-Praktikumsthemen', checked: false, style: '' },
                    { id: 'task4-3', text: 'Praktikum (ab 07.01.) täglich vor/nachbereiten', checked: false, style: '' },
                    { id: 'task-ana-7', text: 'Ana 2 - Lernpaket 7 & 8: Beckensitus, Geschlechtsorgane, Leitungsbahnen', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-ac-4', text: 'AC-Block D: Atomtheorie, PSE, Trends (pdf S. 4-6)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-ana-9', text: 'Ana 3 - Lernpaket 9 & 10: Kopf & Hals', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-ana-11', text: 'Ana 3 - Lernpaket 11 & 12: ZNS, Sinnesorgane', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task-ana-final', text: 'Ana-Block 7: Puffer & Finale Repetition (Ana 1, 2, 3)', checked: false, style: 'font-bold text-red-900' }
                ]
            },
            phase5: { // 21.01. - 07.02.
                goals: [
                    { id: 'goal-histo-retry', text: '<strong>Evtl. Histo-Nachklausur:</strong> 02.02.2026', style: 'p-4 bg-purple-50 rounded-lg text-purple-800' },
                    { id: 'goal5-1', text: '<strong>Biochemie:</strong> 04.02.2026 (9:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal5-2', text: '<strong>Terminologie:</strong> 04.02.2026 (11:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal5-3', text: '<strong>Biologie:</strong> 06.02.2026 (12:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal5-4', text: '<strong>Chemie (AC):</strong> 07.02.2026 (9:00)', style: 'p-4 bg-orange-100 rounded-lg text-orange-900 border border-orange-300' }
                ],
                tasks: [
                    { id: 'task5-1', text: 'Ab 21.01.: Fokus auf Biochemie (Nachbereitung Praktikum) & Termi', checked: false, style: '' },
                    { id: 'task5-2', text: 'Terminologie Vokabeln lernen', checked: false, style: '' },
                    { id: 'task-ac-5', text: 'AC-Block E: Bindungstypen, Lewis, VSEPR (pdf S. 6-10)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task-ac-6', text: 'AC-Block F: Komplexe & Nomenklatur (pdf S. 35-43)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task5-3', text: '04.02. & 05.02.: Fokus auf Biologie für Mediziner', checked: false, style: '' },
                    { id: 'task-ac-7', text: 'AC-Block G: Finale Altklausuren & Formeln (pdf S. 1-3)', checked: false, style: 'font-semibold text-orange-700' },
                    { id: 'task5-4', text: '06.02.: AC-Klausurvorbereitung (letzter Tag)', checked: false, style: 'font-bold text-orange-900' }
                ]
            },
            phase6: { // 08.02. - 30.04.
                goals: [
                    { id: 'goal6-1', text: '<strong>Physiologie Praktikum:</strong> 11.03. - 02.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                    { id: 'goal6-2', text: '<strong>Klausur Physiologie:</strong> 09.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800 font-medium' },
                    { id: 'goal6-3', text: '<strong>Klausur Chemie (OC):</strong> April 2026 (TBD)', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' }
                ],
                tasks: [
                    { id: 'task6-1', text: 'Nach Feb-Klausuren: Pause machen!', checked: false, style: '' },
                    { id: 'task6-2', text: 'Ab Ende Feb.: Physiologie-Stoff der Wochentests reaktivieren', checked: false, style: '' },
                    { id: 'task6-3', text: 'Physiologie-Praktikum (März) intensiv nutzen', checked: false, style: '' },
                    { id: 'task6-4', text: 'Lernplan für OC-Klausur erstellen', checked: false, style: '' }
                ]
            }
        };

        // Der aktuelle Status der Daten
        let dataState;

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            // Aktuelles Datum anzeigen
            currentDateElement.textContent = `Heute: ${now.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            setupMenuListeners(); // V17
            loadStateFromLocalStorage();
            setupGlobalEventListeners();
            renderAllPhases();
            updateOverallProgress(); // Gesamt-Balken
            highlightPhaseStatus(); // Phasen-Status (Farben)
            updateAllPhaseProgressBars(); // Alle Phasen-Balken
        });
        
        // --- V17: Menü-Funktionen ---
        function setupMenuListeners() {
            openBtn.addEventListener('click', () => {
                menu.classList.remove('menu-hidden');
                overlay.classList.remove('hidden');
            });
            closeBtn.addEventListener('click', closeMenu);
            overlay.addEventListener('click', closeMenu);
        }
        
        function closeMenu() {
            menu.classList.add('menu-hidden');
            overlay.classList.add('hidden');
        }

        // --- Globale Event-Listener (Event Delegation) ---
        function setupGlobalEventListeners() {
            planContainer.addEventListener('click', (e) => {
                const target = e.target;
                const parent = e.target.closest('span, input, button'); // Klickziel normalisieren
                if (!parent) return;

                // --- Add-Button ---
                if (parent.classList.contains('add-btn')) {
                    const phase = parent.dataset.phase;
                    const type = parent.dataset.type; // 'goals' or 'tasks'
                    const input = document.getElementById(`new-${type.slice(0, -1)}-input-${phase}`);
                    if (input && input.value.trim()) {
                        addItem(phase, type, input.value.trim());
                        input.value = ''; // Input-Feld leeren
                    }
                }

                // --- Delete-Button ---
                if (parent.classList.contains('delete-btn')) {
                    const { phase, type, id } = parent.dataset;
                    deleteItem(phase, type, id);
                }
                
                // --- Learn-Button (AMBOSS) ---
                if (parent.classList.contains('learn-btn')) {
                    const { text } = parent.dataset;
                    // Der Text ist dank .replace() im HTML-Aufbau bereits sauber
                    const encodedText = encodeURIComponent(text);
                    window.open(`https://next.amboss.com/de/search?q=${encodedText}`, '_blank');
                }

                // --- Checkbox ---
                if (parent.matches('input[type="checkbox"]')) {
                    const { phase, id } = parent.dataset;
                    toggleTask(phase, id, parent.checked);
                }
                
                // --- Edit-Span ---
                if (parent.classList.contains('edit-span') && !parent.isContentEditable) {
                    startEditing(parent);
                }
            });
        }
        
        // --- Editier-Logik ---
        function startEditing(span) {
            if (span.dataset.editing === 'true') return;
            span.dataset.editing = 'true';
            
            const { phase, type, id } = span.dataset;
            const originalHtml = span.innerHTML;
            const originalText = span.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editing-input';
            input.value = originalText;

            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();

            const save = () => {
                const newText = input.value.trim() || originalText;
                const item = dataState[phase][type].find(i => i.id === id);
                if (item) {
                    // Simples HTML-Parsing, um Formatierung zu erhalten
                    if (originalHtml.includes('<strong>')) {
                         item.text = `<strong>${newText.replace(/<\/?strong>/g, '')}</strong>`;
                    } else if (originalHtml.includes('<br>')) {
                         // Ersetze \n (das ein Input macht) zurück zu <br>
                         item.text = newText.replace(/\n/g, '<br>');
                    }
                    else {
                         item.text = newText;
                    }
                    saveStateToLocalStorage();
                }
                span.innerHTML = item ? item.text : originalHtml;
                span.dataset.editing = 'false';
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    save();
                } else if (e.key === 'Escape') {
                    span.innerHTML = originalHtml;
                    span.dataset.editing = 'false';
                }
            });
        }

        // --- Alle Phasen auf der UI rendern ---
        function renderAllPhases() {
            Object.keys(dataState).forEach(phase => {
                renderPhase(phase, 'goals');
                renderPhase(phase, 'tasks');
            });
        }

        // --- Eine einzelne Liste (Ziele oder Tasks) rendern ---
        function renderPhase(phase, type) { // type is 'goals' or 'tasks'
            const listElement = document.getElementById(`${phase}-${type}`);
            if (!listElement) return; 
            listElement.innerHTML = ''; 

            if (!dataState[phase] || !dataState[phase][type]) return;

            dataState[phase][type].forEach(item => {
                let li;
                if (type === 'goals') {
                    li = createGoalElement(item, phase);
                } else {
                    li = createTaskElement(item, phase);
                }
                listElement.appendChild(li);
            });
        }
        
        // --- HTML für ein Ziel-Element erstellen ---
        function createGoalElement(goal, phase) {
            const li = document.createElement('li');
            li.className = `goal-item flex justify-between items-center ${goal.style || 'p-4 bg-gray-50 rounded-lg text-gray-800'}`;
            li.innerHTML = `
                <span class="learn-btn" data-text="${goal.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">📚</span>
                <span class="edit-span flex-grow" data-phase="${phase}" data-type="goals" data-id="${goal.id}">${goal.text}</span>
                <span data-phase="${phase}" data-type="goals" data-id="${goal.id}" class="delete-btn" title="Löschen">X</span>
            `;
            return li;
        }

        // --- HTML für ein Task-Element erstellen ---
        function createTaskElement(task, phase) {
            const li = document.createElement('li');
            li.className = 'task-item flex justify-between items-center bg-gray-50 p-2 rounded-lg';
            
            const labelStyle = task.style || '';
            const disabled = task.disabled ? 'disabled' : '';

            li.innerHTML = `
                <div class="flex-grow flex items-center">
                    <input type="checkbox" id="${task.id}" data-phase="${phase}" data-id="${task.id}" ${task.checked ? 'checked' : ''} ${disabled} class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 flex-shrink-0">
                    <label for="${task.id}" class="ml-3 ${labelStyle} ${disabled ? 'text-gray-400' : 'text-gray-800'} w-full">
                         <span class="edit-span" data-phase="${phase}" data-type="tasks" data-id="${task.id}">${task.text}</span>
                    </label>
                </div>
                <span class="learn-btn" data-text="${task.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">📚</span>
                ${!disabled ? `<span data-phase="${phase}" data-type="tasks" data-id="${task.id}" class="delete-btn" title="Löschen">X</span>` : ''}
            `;
            return li;
        }


        // --- CRUD-Logik-Funktionen ---
        
        function addItem(phase, type, text) {
            const newItem = {
                id: `item-${Date.now()}`,
                text: text,
                style: (type === 'goals') ? 'p-4 bg-gray-50 rounded-lg text-gray-800' : '',
                checked: false,
                custom: true
            };
            dataState[phase][type].push(newItem);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        function toggleTask(phase, taskId, isChecked) {
            const task = dataState[phase].tasks.find(t => t.id === taskId);
            if (task) {
                task.checked = isChecked;
                saveStateToLocalStorage();
            }
        }

        function deleteItem(phase, type, id) {
            dataState[phase][type] = dataState[phase][type].filter(item => item.id !== id);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        // --- Daten von localStorage laden ---
        function loadStateFromLocalStorage() {
            statusElement.textContent = "Lade...";
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            
            if (savedState) {
                dataState = JSON.parse(savedState);
                // Stelle sicher, dass alle Phasen/Typen existieren
                Object.keys(defaultData).forEach(phase => {
                    if (!dataState[phase]) {
                        dataState[phase] = defaultData[phase];
                    } else {
                        if (!dataState[phase].goals) dataState[phase].goals = defaultData[phase].goals;
                        if (!dataState[phase].tasks) dataState[phase].tasks = defaultData[phase].tasks;
                    }
                });
            } else {
                dataState = JSON.parse(JSON.stringify(defaultData)); // Tiefe Kopie
            }
            statusElement.textContent = "Bereit";
        }

        // --- Daten in localStorage speichern (mit Debounce) ---
        function saveStateToLocalStorage() {
            clearTimeout(debounceTimer);
            statusElement.textContent = "Speichere...";
            statusElement.classList.add('syncing');
            
            debounceTimer = setTimeout(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataState));
                    statusElement.textContent = "Lokal gespeichert";
                    // UI-Updates nach dem Speichern
                    updateOverallProgress(); // Gesamt-Balken
                    highlightPhaseStatus(); // Phasen-Status (Farben)
                    updateAllPhaseProgressBars(); // Alle Phasen-Balken (liest Phasen-Status)
                } catch (error) {
                    console.error("Fehler beim Speichern in localStorage:", error);
                    statusElement.textContent = "Speicherfehler!";
                } finally {
                    statusElement.classList.remove('syncing');
                }
            }, 1000); // 1 Sekunde Verzögerung
        }
        
        // --- Fortschritt & Status Updates ---
        
        function updateOverallProgress() {
            let totalTasks = 0;
            let checkedTasks = 0;
            
            Object.keys(dataState).forEach(phase => {
                dataState[phase].tasks.forEach(task => {
                    if (!task.disabled) { 
                        totalTasks++;
                        if (task.checked) {
                            checkedTasks++;
                        }
                    }
                });
            });
            
            const percentage = (totalTasks === 0) ? 0 : Math.round((checkedTasks / totalTasks) * 100);
            
            globalProgressBar.style.width = `${percentage}%`;
            globalProgressText.textContent = `${percentage}% (${checkedTasks}/${totalTasks})`;
        }

        function updatePhaseProgress(phase) {
            if (!dataState[phase] || !dataState[phase].tasks) return;
            
            let totalTasks = 0;
            let checkedTasks = 0;
            dataState[phase].tasks.forEach(task => {
                if (!task.disabled) {
                    totalTasks++;
                    if (task.checked) {
                        checkedTasks++;
                    }
                }
            });

            const percentage = (totalTasks === 0) ? 100 : Math.round((checkedTasks / totalTasks) * 100);
            const bar = document.getElementById(`${phase}-progress-bar`);
            const text = document.getElementById(`${phase}-progress-text`);

            if (bar) bar.style.width = `${percentage}%`;
            if (text) text.textContent = `${percentage}% (${checkedTasks}/${totalTasks})`;

            if (bar) {
                bar.classList.remove('bg-gray-600', 'bg-blue-600', 'bg-green-500', 'bg-red-600');
                const statusIcon = document.getElementById(`${phase}-status`);
                
                if (percentage === 100) {
                    bar.classList.add('bg-green-500'); // Erledigt
                } else if (statusIcon && statusIcon.classList.contains('bg-red-500')) {
                    bar.classList.add('bg-red-600'); // Überfällig
                } else if (statusIcon && statusIcon.classList.contains('bg-blue-500')) {
                    bar.classList.add('bg-blue-600'); // Aktiv
                } else {
                    bar.classList.add('bg-gray-600'); // Zukünftig
                }
            }
        }

        function updateAllPhaseProgressBars() {
            Object.keys(dataState).forEach(phase => {
                updatePhaseProgress(phase);
            });
        }
        
        function highlightPhaseStatus() {
            Object.keys(phaseMetadata).forEach(phase => {
                const meta = phaseMetadata[phase];
                const phaseData = dataState[phase];
                const icon = document.getElementById(`${phase}-status`);
                const section = document.getElementById(`${phase}-section`);
                
                if (!icon || !section || !phaseData) {
                    return;
                }

                icon.className = 'phase-status-icon';
                section.style.border = 'none';

                const openTasks = phaseData.tasks.some(task => !task.checked && !task.disabled);
                if (!openTasks) {
                    icon.classList.add('bg-green-500'); // Grün: Erledigt
                    icon.title = "Erledigt";
                    section.style.borderColor = '#22c55e'; // green-500
                    return;
                }
                
                if (now >= meta.startDate && now <= meta.endDate) {
                    icon.classList.add('bg-blue-500'); // Blau: Aktiv
                    icon.title = "Aktive Phase";
                    section.style.border = '2px solid #3b82f6'; // blue-500
                } else if (now > meta.endDate && openTasks) {
                    icon.classList.add('bg-red-500'); // Rot: Überfällig
                    icon.title = "Überfällig (Aufgaben offen)";
                    section.style.border = '2px solid #ef4444'; // red-500
                } else if (now < meta.startDate) {
                    icon.classList.add('bg-gray-300'); // Grau: Zukünftig
                    icon.title = "Zukünftig";
                } else {
                     icon.classList.add('bg-gray-300'); // Grau: Vergangen (aber erledigt)
                    icon.title = "Vergangen";
                }
            });
        }

    </script>
</body>
</html>
