<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dein Med-Lernplan WS 25/26 (V7 - Self-Host Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-item input:checked + label {
            text-decoration: line-through;
            color: #6b7280;
        }
        .task-item label {
            transition: color 0.2s ease-in-out;
        }
        /* Kleine Lade-Animation für den Sync-Status */
        #auth-status.syncing::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' '; }
        }
    </style>
</head>
<body class="h-full p-4 md:p-8 bg-gray-100">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Dein Med-Lernplan WS 25/26 (V6)</h1>
                    <p class="text-lg text-gray-600">Interaktiver Plan - Jetzt mit Weihnachtspause & neuen Ana-Blöcken.</p>
                </div>
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Dein Med-Lernplan WS 25/26 (V6)</h1>
                    <p class="text-lg text-gray-600">Interaktiver Plan - Jetzt mit Weihnachtspause & neuen Ana-Blöcken.</p>
                </div>
                <div class="text-right">
                    <span id="auth-status" class="text-sm text-gray-500">Initialisiere...</span>
                </div>
            </div>
        </header>

        <!-- Container für die Lernphasen -->
        <div class="space-y-8">

            <!-- Phase 1: Aktueller Fokus -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">Phase 1: Aktueller Fokus (Bis 07.11.2025)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziel dieser Woche</h3>
                        <p class="p-4 bg-blue-50 rounded-lg text-blue-800">
                            <strong>Testat:</strong> Wöchentlicher Physio-Test (07.11.)
                        </p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <ul class="space-y-2 task-list" id="phase1-tasks">
                            <li class="task-item"><input type="checkbox" id="task1-1"><label for="task1-1" class="ml-2">Thema "Blut I" (Zusammensetzung) lernen</label></li>
                            <li class="task-item"><input type="checkbox" id="task1-2"><label for="task1-2" class="ml-2">Thema "Erythrozyten & Anämien" verstehen</label></li>
                            <li class="task-item"><input type="checkbox" id="task1-3"><label for="task1-3" class="ml-2">Thema "Blutgruppen" wiederholen</label></li>
                            <li class="task-item"><input type="checkbox" id="task1-4"><label for="task1-4" class="ml-2">Plan für AC-Selbststudium erstellen (z.B. 1 Thema/Woche)</label></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 2: Der Große Dauerlauf -->
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Phase 2: Der große Dauerlauf (08.11. - 20.12.2025)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                        <ul class="space-y-3">
                            <li class="p-4 bg-red-50 rounded-lg text-red-800 font-medium"><strong>Ana-Blöcke 1-3</strong> (Rumpf, Arm, Bein)</li>
                            <li class="p-4 bg-orange-50 rounded-lg text-orange-800 font-medium"><strong>Dauerlauf</strong> AC-Selbststudium</li>
                            <li class="p-4 bg-blue-50 rounded-lg text-blue-800"><strong>Dauerlauf:</strong> Wöchentliche Physio-Tests</li>
                            <li class="p-4 bg-blue-100 rounded-lg text-blue-900 border border-blue-300">
                                <strong>Physio-Ziel:</strong> 26 Punkte (min.)<br>
                                <strong>Status:</strong> 11/26<br>
                                <strong>Bedarf:</strong> 15 Punkte aus 6 Tests (Schnitt: 2.5/6)
                            </li>
                            <li class="p-4 bg-yellow-50 rounded-lg text-yellow-800"><strong>Klausur:</strong> Med. Psychologie (09.12.)</li>
                            <li class="p-4 bg-teal-50 rounded-lg text-teal-800"><strong>Urlaub:</strong> 19.11. - 21.11. (Buenos Aires!)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <ul class="space-y-2 task-list" id="phase2-tasks">
                            <li class="task-item"><input type="checkbox" id="task2-ana-1"><label for="task2-ana-1" class="ml-2 font-semibold text-red-700">Ana-Block 1: Rumpfwand & Rücken (bis ca. 22.11.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-3"><label for="task2-3" class="ml-2">Wöchentlich 1-2 feste Blöcke für AC-Selbststudium einplanen</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-4"><label for="task2-4" class="ml-2">Physio Test (14.11.): Blut II (Hämostase, Immunologie)</label></li>
                            <li class="task-item"><input type="checkbox" id="task-vacation" disabled><label for="task-vacation" class="ml-2 text-teal-700 font-medium">Blocker: URLAUB (19.11. - 21.11.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-5"><label for="task2-5" class="ml-2">Nachholen (nach 21.11.): Physio-Stoff "Energiehaushalt"</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-ana-2"><label for="task2-ana-2" class="ml-2 font-semibold text-red-700">Ana-Block 2: Obere Extremität (bis ca. 06.12.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-6"><label for="task2-6" class="ml-2">Ab 25.11.: Intensiv-Lernphase Med. Psychologie starten</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-7"><label for="task2-7" class="ml-2">Physio Test (28.11.): Atmung I</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-8"><label for="task2-8" class="ml-2">Physio Test (05.12.): Atmung II</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-9"><label for="task2-9" class="ml-2">Physio Test (12.12.): Niere I</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-ana-3"><label for="task2-ana-3" class="ml-2 font-semibold text-red-700">Ana-Block 3: Untere Extremität (bis ca. 20.12.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-10"><label for="task2-10" class="ml-2">Physio Test (19.12.): Elektrolyt-/Säure-Basen</label></li>
                            <li class="task-item"><input type="checkbox" id="task2-histo"><label for="task2-histo" class="ml-2">Histo: Themen parallel zu Makro-Blöcken lernen</label></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 3: Fokus Anatomie & Biochemie -->
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Phase 3: Ana-Endspurt & Biochemie (21.12.2025 - 20.01.2026)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Hauptziele</h3>
                         <ul class="space-y-3">
                            <li class="p-4 bg-teal-50 rounded-lg text-teal-800 font-medium"><strong>WEIHNACHTSPAUSE:</strong> (21.12. - 26.12.)</li>
                            <li class="p-4 bg-red-50 rounded-lg text-red-800"><strong>Ana-Blöcke 4-6</strong> (Organe, Kopf/Hals)</li>
                            <li class="p-4 bg-green-50 rounded-lg text-green-800 font-medium"><strong>Start Biochemie Praktikum:</strong> 07.01.2026</li>
                            <li class="p-4 bg-red-100 rounded-lg text-red-900 font-medium border border-red-300"><strong>FINALE: Ganzkörpertestat:</strong> 20.01.2026</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste (NEU mit Weihnachtspause)</h3>
                        <ul class="space-y-2 task-list" id="phase3-tasks">
                            <li class="task-item"><input type="checkbox" id="task-xmas" disabled><label for="task-xmas" class="ml-2 text-teal-700 font-medium">Blocker: WEIHNACHTSPAUSE (21.12. - 26.12.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-ana-4"><label for="task3-ana-4" class="ml-2 font-semibold text-red-700">Ana-Block 4: Brustorgane (27.12. - 05.01.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-2"><label for="task3-2" class="ml-2">Vor 07.01.: Überblick Biochemie-Praktikumsthemen</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-3"><label for="task3-3" class="ml-2">Praktikum (ab 07.01.) täglich vor/nachbereiten</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-ana-5"><label for="task3-ana-5" class="ml-2 font-semibold text-red-700">Ana-Block 5: Bauch- & Beckenorgane (06.01. - 12.01.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-ana-6"><label for="task3-ana-6" class="ml-2 font-semibold text-red-700">Ana-Block 6: Kopf & Hals (13.01. - 18.01.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-ana-7"><label for="task3-ana-7" class="ml-2 font-bold text-red-900">Ana-Block 7: Puffer & Finale Repetition (19.01. - 20.01.)</label></li>
                            <li class="task-item"><input type="checkbox" id="task3-5"><label for="task3-5" class="ml-2">Parallel AC-Selbststudium weiterführen!</label></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 4: Klausurenphase -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-red-300">
                <h2 class="text-2xl font-semibold text-red-700 mb-4">Phase 4: Klausurenphase (21.01. - 07.02.2026)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Alle Klausuren</h3>
                        <ul class="space-y-3">
                            <li class="p-4 bg-gray-50 rounded-lg text-gray-800">
                                <strong>Biochemie:</strong> 04.02.2026 (9:00)
                            </li>
                            <li class="p-4 bg-gray-50 rounded-lg text-gray-800">
                                <strong>Terminologie:</strong> 04.02.2026 (11:00)
                            </li>
                            <li class="p-4 bg-gray-50 rounded-lg text-gray-800">
                                <strong>Biologie:</strong> 06.02.2026 (12:00)
                            </li>
                            <li class="p-4 bg-gray-50 rounded-lg text-gray-800">
                                <strong>Chemie (AC):</strong> 07.02.2026 (9:00)
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <ul class="space-y-2 task-list" id="phase4-tasks">
                            <li class="task-item"><input type="checkbox" id="task4-1"><label for="task4-1" class="ml-2">Ab 21.01.: Fokus auf Biochemie (Nachbereitung Praktikum) & Termi</label></li>
                            <li class="task-item"><input type="checkbox" id="task4-2"><label for="task4-2" class="ml-2">Terminologie Vokabeln lernen</label></li>
                            <li class="task-item"><input type="checkbox" id="task4-3"><label for="task4-3" class="ml-2">04.02. & 05.02.: Fokus auf Biologie für Mediziner</label></li>
                            <li class="task-item"><input type="checkbox" id="task4-4"><label for="task4-4" class="ml-2">06.02.: Finale Lernphase für AC-Klausur</label></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 5: Langfristige Ziele -->
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Phase 5: Langfristige Ziele (Frühjahr 2026)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Zukünftige Prüfungen</h3>
                         <ul class="space-y-3">
                            <li class="p-4 bg-blue-50 rounded-lg text-blue-800"><strong>Physiologie Praktikum:</strong> 11.03. - 02.04.2026</li>
                            <li class="p-4 bg-blue-50 rounded-lg text-blue-800 font-medium"><strong>Klausur Physiologie:</strong> 09.04.2026</li>
                            <li class="p-4 bg-yellow-50 rounded-lg text-yellow-800"><strong>Klausur Chemie (OC):</strong> April 2026 (TBD)</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <ul class="space-y-2 task-list" id="phase5-tasks">
                            <li class="task-item"><input type="checkbox" id="task5-1"><label for="task5-1" class="ml-2">Nach Feb-Klausuren: Pause machen!</label></li>
                            <li class="task-item"><input type="checkbox" id="task5-2"><label for="task5-2" class="ml-2">Ab Ende Feb.: Physiologie-Stoff der Wochentests reaktivieren</label></li>
                            <li class="task-item"><input type="checkbox" id="task5-3"><label for="task5-3" class="ml-2">Physiologie-Praktikum (März) intensiv nutzen</label></li>
                            <li class="task-item"><input type="checkbox" id="task5-4"><label for="task5-4" class="ml-2">Lernplan für OC-Klausur erstellen</label></li>
                        </ul>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importiere notwendige Firebase Module
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Globale Variablen ---
        let db;
        let auth;
        let userId = null;
        let dbRef = null; // Referenz zum Firestore-Dokument
        let allCheckboxes = [];
        let debounceTimer; // Für verzögertes Speichern
        
        const statusElement = document.getElementById('auth-status');

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- HIER DEINE FIREBASE KONFIGURATION EINFÜGEN ---
            // Du erhältst dies, wenn du eine "Web-App" in deinem Firebase-Projekt erstellst (siehe Schritt 2).
            const firebaseConfig = {
                apiKey: "DEIN_API_KEY", // Ersetze "DEIN_API_KEY"
                authDomain: "DEIN_PROJEKT.firebaseapp.com",
                projectId: "DEIN_PROJEKT_ID",
                storageBucket: "DEIN_PROJEKT.appspot.com",
                messagingSenderId: "DEIN_SENDER_ID",
                appId: "DEIN_APP_ID"
                // measurementId: "G-..." // Falls vorhanden
            };
            
            // Verwende deine Projekt-ID als App-ID für den Datenbankpfad,
            // oder eine beliebige eindeutige Zeichenfolge.
            const appId = firebaseConfig.projectId || 'default-study-plan';

            // Firebase initialisieren
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase-Initialisierung fehlgeschlagen:", e);
                statusElement.textContent = "Fehler bei Init.";
                return;
            }

            // Alle Checkboxen einmal sammeln
            allCheckboxes = Array.from(document.querySelectorAll('.task-list input[type="checkbox"]'));

            // Authentifizierung starten
            handleAuth(appId);
        });

        // --- Authentifizierung (VEREINFACHT FÜR SELF-HOSTING) ---
        async function handleAuth(appId) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // User ist bereits angemeldet
                    userId = user.uid;
                } else {
                    // Wenn kein User da ist, anonym anmelden
                    // Dies ist die korrekte Methode für deine GitHub Pages-Version
                    try {
                        await signInAnonymously(auth);
                        userId = auth.currentUser?.uid; // ID nach Anmeldung holen
                    } catch (error) {
                        console.error("Authentifizierungsfehler:", error);
                        console.error("--- WICHTIGER HINWEIS: HAST DU DEINE FIREBASE-KONFIGURATION OBEN (Zeile 250) EINGEFÜGT? ---");
                        statusElement.textContent = "Auth-Fehler (API Key?)";
                    }
                }

                if (userId) {
                    statusElement.textContent = `Verbunden (ID: ${userId.substring(0, 6)}...)`;
                    // Pfad zum Firestore-Dokument definieren
                    dbRef = doc(db, `artifacts/${appId}/users/${userId}/study-plan`, 'tasks');
                    
                    // Daten von Firestore laden UND Event-Listener einrichten
                    loadStateFromFirestore();
                    setupSaveListeners();
                } else {
                    console.error("Konnte keine User-ID erhalten.");
                    statusElement.textContent = "Offline. Fortschritt wird nicht gespeichert.";
                }
            });
        }

        // --- Daten von Firestore laden ---
        function loadStateFromFirestore() {
            statusElement.textContent = "Lade Daten...";
            
            // onSnapshot hört auf Änderungen in Echtzeit
            onSnapshot(dbRef, (docSnap) => {
                if (docSnap.exists()) {
                    const taskData = docSnap.data();
                    // Checkboxen basierend auf geladenen Daten aktualisieren
                    allCheckboxes.forEach(checkbox => {
                        if (taskData[checkbox.id] === true) {
                            checkbox.checked = true;
                        } else {
                            checkbox.checked = false; // Wichtig, um "false" zu setzen
                        }
                    });
                } else {
                    // Falls kein Dokument existiert (z.B. erster Besuch)
                    // wird es beim nächsten Speichern automatisch erstellt.
                    console.log("Noch kein Dokument vorhanden. Wird bei der ersten Änderung erstellt.");
                }
                statusElement.textContent = `Synchronisiert (ID: ${userId.substring(0, 6)}...)`;
            }, (error) => {
                console.error("Fehler beim Laden von Firestore:", error);
                statusElement.textContent = "Sync-Fehler";
            });
        }

        // --- Event-Listener für das Speichern einrichten ---
        function setupSaveListeners() {
            allCheckboxes.forEach(checkbox => {
                // Event-Listener hinzufügen, der die Speicherfunktion aufruft
                checkbox.addEventListener('change', saveStateToFirestore);
            });
        }

        // --- Daten in Firestore speichern (mit Debounce) ---
        function saveStateToFirestore() {
            // "Debouncing": Wartet 1 Sekunde nach der letzten Änderung, bevor gespeichert wird
            clearTimeout(debounceTimer);
            statusElement.textContent = "Änderungen erkannt...";
            statusElement.classList.add('syncing'); // Lade-Animation
            
            debounceTimer = setTimeout(async () => {
                const tasksToSave = {};
                // Den Status aller Checkboxen sammeln
                allCheckboxes.forEach(checkbox => {
                    tasksToSave[checkbox.id] = checkbox.checked;
                });

                try {
                    // setDoc mit { merge: false } überschreibt das Dokument komplett
                    // Das ist hier gewollt, um den exakten Stand der UI abzubilden
                    await setDoc(dbRef, tasksToSave, { merge: false });
                    statusElement.textContent = `Synchronisiert (ID: ${userId.substring(0, 6)}...)`;
                } catch (error) {
                    console.error("Fehler beim Speichern in Firestore:", error);
                    statusElement.textContent = "Speicherfehler!";
                } finally {
                    statusElement.classList.remove('syncing'); // Lade-Animation entfernen
                }
            }, 1000); // 1 Sekunde Verzögerung
        }

    </script>
</body>
</html>
