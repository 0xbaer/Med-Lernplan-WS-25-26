<!DOCTYPE html>
<html lang="de" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mein Medi-Lernplan WS 25/26 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Stil f√ºr abgehakte Aufgaben */
        .task-item input:checked + label .edit-span {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .task-item label, .goal-item .edit-span {
            transition: color 0.2s ease-in-out;
            cursor: pointer;
            display: inline-block; /* Wichtig f√ºr Klickbarkeit */
            width: 100%;
        }
        /* Hover-Effekt f√ºr editierbare Texte */
        .goal-item .edit-span:hover, .task-item label .edit-span:hover {
            background-color: #eff6ff; /* blue-50 */
            border-radius: 3px;
            box-shadow: 0 0 0 1px #dbeafe; /* blue-100 */
        }
        /* Speicher-Animation */
        #save-status.syncing::after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ' '; }
        }
        /* L√∂schen-Button (rotes X) */
        .delete-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            font-weight: bold;
            padding: 0 4px;
            font-family: monospace;
            color: #ef4444; /* red-500 */
            align-self: flex-start;
        }
        /* "Lernen"-Button (Buch) */
        .learn-btn {
            opacity: 0.3;
            transition: opacity 0.2s;
            cursor: pointer;
            padding: 0 6px;
            align-self: flex-start;
        }
        .task-item:hover .delete-btn, .goal-item:hover .delete-btn,
        .task-item:hover .learn-btn, .goal-item:hover .learn-btn {
            opacity: 1;
        }
        /* Eingabefeld, das beim Editieren erscheint */
        .editing-input {
            width: 95%;
            padding: 2px 4px;
            border: 1px solid #3b82f6; /* blue-500 */
            border-radius: 3px;
            outline: none;
            font: inherit;
        }
        .phase-status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body class="h-full p-4 md:p-8 bg-gray-100">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-2">Mein Medi-Lernplan WS 25/26 </h1>
                    <p class="text-lg text-gray-600">Interaktiver Plan mit AMBOSS-Link.</p>
                </div>
                <div class="text-left md:text-right mt-4 md:mt-0">
                    <span id="current-date" class="text-sm font-semibold text-blue-700">Lade Datum...</span><br>
                    <span id="save-status" class="text-sm text-gray-500">Bereit</span>
                </div>
            </div>

            <!-- Fortschrittsbalken -->
            <div class="mt-8">
                <div class="flex justify-between mb-1">
                    <span class="text-base font-medium text-blue-700">Gesamtfortschritt</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-700">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

        </header>

        <!-- Container f√ºr die Lernphasen -->
        <div class="space-y-8" id="plan-container">

            <!-- Phase 1: Aktueller Fokus -->
            <section id="phase1-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-700 mb-4">
                    <span id="phase1-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 1: Aktueller Fokus (Bis 07.11.2025)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase1" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <button data-phase="phase1" data-type="goals" class="add-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase1-goals">
                            <!-- JS f√ºgt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase1" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                            <button data-phase="phase1" data-type="tasks" class="add-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase1-tasks">
                            <!-- JS f√ºgt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 2: Der Gro√üe Dauerlauf -->
            <section id="phase2-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase2-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 2: Der gro√üe Dauerlauf (08.11. - 20.12.2025)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Ziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase2" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase2" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase2-goals">
                            <!-- JS f√ºgt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase2" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase2" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase2-tasks">
                            <!-- JS f√ºgt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 3: Fokus Anatomie & Biochemie -->
            <section id="phase3-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase3-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 3: Ana-Endspurt & Biochemie (21.12.2025 - 20.01.2026)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Hauptziele</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase3" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase3" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                         <ul class="space-y-3 goal-list" id="phase3-goals">
                            <!-- JS f√ºgt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase3" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase3" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase3-tasks">
                            <!-- JS f√ºgt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 4: Klausurenphase -->
            <section id="phase4-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-red-700 mb-4">
                    <span id="phase4-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 4: Klausurenphase (21.01. - 07.02.2026)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Alle Klausuren</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase4" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-300">
                            <button data-phase="phase4" data-type="goals" class="add-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-3 goal-list" id="phase4-goals">
                            <!-- JS f√ºgt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase4" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-300">
                            <button data-phase="phase4" data-type="tasks" class="add-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase4-tasks">
                            <!-- JS f√ºgt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Phase 5: Langfristige Ziele -->
            <section id="phase5-section" class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                    <span id="phase5-status" class="phase-status-icon bg-gray-300" title="Status"></span>
                    Phase 5: Langfristige Ziele (Fr√ºhjahr 2026)
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Ziele (Links) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Zuk√ºnftige Pr√ºfungen</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-goal-input-phase5" placeholder="Neues Ziel..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase5" data-type="goals" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                         <ul class="space-y-3 goal-list" id="phase5-goals">
                            <!-- JS f√ºgt Ziele hier ein -->
                        </ul>
                    </div>
                    <!-- Tracking (Rechts) -->
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Tracking-Liste</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-task-input-phase5" placeholder="Neue Aufgabe..." class="flex-grow border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <button data-phase="phase5" data-type="tasks" class="add-btn bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-sm font-semibold">Add</button>
                        </div>
                        <ul class="space-y-2 task-list" id="phase5-tasks">
                            <!-- JS f√ºgt Tasks hier ein -->
                        </ul>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Lokales Speicher-Skript (V12 - AMBOSS Link) -->
    <script type="module">
        
        // --- Globale Variablen ---
        let debounceTimer; // F√ºr verz√∂gertes Speichern
        const statusElement = document.getElementById('save-status');
        const LOCAL_STORAGE_KEY = 'meinMedizinLernplan_V12'; // Neuer Key f√ºr V12
        const planContainer = document.getElementById('plan-container');
        const currentDateElement = document.getElementById('current-date');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // Simuliertes heutiges Datum f√ºr Tests (z.B. '2025-11-06T12:00:00')
        // const now = new Date('2025-11-06T12:00:00'); // Test: Phase 1 aktiv
        // const now = new Date('2025-12-22T12:00:00'); // Test: Phase 3 aktiv / Phase 2 √ºberf√§llig
        const now = new Date(); // Echtes Datum verwenden
        
        // --- Phasen-Zeit-Metadaten ---
        // (Monate sind 0-basiert: 0=Jan, 10=Nov, 11=Dez)
        const phaseMetadata = {
            phase1: { startDate: new Date('2025-10-01'), endDate: new Date('2025-11-07T23:59:59') },
            phase2: { startDate: new Date('2025-11-08'), endDate: new Date('2025-12-20T23:59:59') },
            phase3: { startDate: new Date('2025-12-21'), endDate: new Date('2026-01-20T23:59:59') },
            phase4: { startDate: new Date('2026-01-21'), endDate: new Date('2026-02-07T23:59:59') },
            phase5: { startDate: new Date('2026-02-08'), endDate: new Date('2026-04-30T23:59:59') }
        };

        // --- Standard-Datenstruktur (Ziele & Aufgaben) ---
        const defaultData = {
            phase1: {
                goals: [
                    { id: 'goal1-1', text: '<strong>Testat:</strong> W√∂chentlicher Physio-Test (07.11.)', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' }
                ],
                tasks: [
                    { id: 'task1-1', text: 'Thema "Blut I" (Zusammensetzung) lernen', checked: false, style: '' },
                    { id: 'task1-2', text: 'Thema "Erythrozyten & An√§mien" verstehen', checked: false, style: '' },
                    { id: 'task1-3', text: 'Thema "Blutgruppen" wiederholen', checked: false, style: '' },
                    { id: 'task1-4', text: 'Plan f√ºr AC-Selbststudium erstellen (z.B. 1 Thema/Woche)', checked: false, style: '' }
                ]
            },
            phase2: {
                goals: [
                    { id: 'goal2-1', text: '<strong>Ana-Bl√∂cke 1-3</strong> (Rumpf, Arm, Bein)', style: 'p-4 bg-red-50 rounded-lg text-red-800 font-medium' },
                    { id: 'goal2-2', text: '<strong>Dauerlauf</strong> AC-Selbststudium', style: 'p-4 bg-orange-50 rounded-lg text-orange-800 font-medium' },
                    { id: 'goal2-3', text: '<strong>Dauerlauf:</strong> W√∂chentliche Physio-Tests', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                    { id: 'goal2-4', text: '<strong>Physio-Ziel:</strong> 26 Punkte (min.)<br><strong>Status:</strong> 11/26<br><strong>Bedarf:</strong> 15 Punkte aus 6 Tests (Schnitt: 2.5/6)', style: 'p-4 bg-blue-100 rounded-lg text-blue-900 border border-blue-300' },
                    { id: 'goal2-5', text: '<strong>Klausur:</strong> Med. Psychologie (09.12.)', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' },
                    { id: 'goal2-6', text: '<strong>Urlaub:</strong> 19.11. - 21.11. (Buenos Aires!)', style: 'p-4 bg-teal-50 rounded-lg text-teal-800' }
                ],
                tasks: [
                    { id: 'task2-1', text: 'Ana-Block 1: Rumpfwand & R√ºcken (bis ca. 22.11.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task2-2', text: 'W√∂chentlich 1-2 feste Bl√∂cke f√ºr AC-Selbststudium einplanen', checked: false, style: '' },
                    { id: 'task2-3', text: 'Physio Test (14.11.): Blut II (H√§mostase, Immunologie)', checked: false, style: '' },
                    { id: 'task-vacation', text: 'Blocker: URLAUB (19.11. - 21.11.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' },
                    { id: 'task2-4', text: 'Nachholen (nach 21.11.): Physio-Stoff "Energiehaushalt"', checked: false, style: '' },
                    { id: 'task2-5', text: 'Ana-Block 2: Obere Extremit√§t (bis ca. 06.12.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task2-6', text: 'Ab 25.11.: Intensiv-Lernphase Med. Psychologie starten', checked: false, style: '' },
                    { id: 'task2-7', text: 'Physio Test (28.11.): Atmung I', checked: false, style: '' },
                    { id: 'task2-8', text: 'Physio Test (05.12.): Atmung II', checked: false, style: '' },
                    { id: 'task2-9', text: 'Physio Test (12.12.): Niere I', checked: false, style: '' },
                    { id: 'task2-10', text: 'Ana-Block 3: Untere Extremit√§t (bis ca. 20.12.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task2-11', text: 'Physio Test (19.12.): Elektrolyt-/S√§ure-Basen', checked: false, style: '' },
                    { id: 'task2-12', text: 'Histo: Themen parallel zu Makro-Bl√∂cken lernen', checked: false, style: '' }
                ]
            },
            phase3: {
                goals: [
                    { id: 'goal3-1', text: '<strong>WEIHNACHTSPAUSE:</strong> (21.12. - 26.12.)', style: 'p-4 bg-teal-50 rounded-lg text-teal-800 font-medium' },
                    { id: 'goal3-2', text: '<strong>Ana-Bl√∂cke 4-6</strong> (Organe, Kopf/Hals)', style: 'p-4 bg-red-50 rounded-lg text-red-800' },
                    { id: 'goal3-3', text: '<strong>Start Biochemie Praktikum:</strong> 07.01.2026', style: 'p-4 bg-green-50 rounded-lg text-green-800 font-medium' },
                    { id: 'goal3-4', text: '<strong>FINALE: Ganzk√∂rpertestat:</strong> 20.01.2026', style: 'p-4 bg-red-100 rounded-lg text-red-900 font-medium border border-red-300' }
                ],
                tasks: [
                    { id: 'task-xmas', text: 'Blocker: WEIHNACHTSPAUSE (21.12. - 26.12.)', checked: true, disabled: true, style: 'text-teal-700 font-medium' },
                    { id: 'task3-1', text: 'Ana-Block 4: Brustorgane (27.12. - 05.01.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task3-2', text: 'Vor 07.01.: √úberblick Biochemie-Praktikumsthemen', checked: false, style: '' },
                    { id: 'task3-3', text: 'Praktikum (ab 07.01.) t√§glich vor/nachbereiten', checked: false, style: '' },
                    { id: 'task3-4', text: 'Ana-Block 5: Bauch- & Beckenorgane (06.01. - 12.01.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task3-5', text: 'Ana-Block 6: Kopf & Hals (13.01. - 18.01.)', checked: false, style: 'font-semibold text-red-700' },
                    { id: 'task3-6', text: 'Ana-Block 7: Puffer & Finale Repetition (19.01. - 20.01.)', checked: false, style: 'font-bold text-red-900' },
                    { id: 'task3-7', text: 'Parallel AC-Selbststudium weiterf√ºhren!', checked: false, style: '' }
                ]
            },
            phase4: {
                goals: [
                    { id: 'goal4-1', text: '<strong>Biochemie:</strong> 04.02.2026 (9:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal4-2', text: '<strong>Terminologie:</strong> 04.02.2026 (11:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal4-3', text: '<strong>Biologie:</strong> 06.02.2026 (12:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' },
                    { id: 'goal4-4', text: '<strong>Chemie (AC):</strong> 07.02.2026 (9:00)', style: 'p-4 bg-gray-50 rounded-lg text-gray-800' }
                ],
                tasks: [
                    { id: 'task4-1', text: 'Ab 21.01.: Fokus auf Biochemie (Nachbereitung Praktikum) & Termi', checked: false, style: '' },
                    { id: 'task4-2', text: 'Terminologie Vokabeln lernen', checked: false, style: '' },
                    { id: 'task4-3', text: '04.02. & 05.02.: Fokus auf Biologie f√ºr Mediziner', checked: false, style: '' },
                    { id: 'task4-4', text: '06.02.: Finale Lernphase f√ºr AC-Klausur', checked: false, style: '' }
                ]
            },
            phase5: {
                goals: [
                    { id: 'goal5-1', text: '<strong>Physiologie Praktikum:</strong> 11.03. - 02.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800' },
                    { id: 'goal5-2', text: '<strong>Klausur Physiologie:</strong> 09.04.2026', style: 'p-4 bg-blue-50 rounded-lg text-blue-800 font-medium' },
                    { id: 'goal5-3', text: '<strong>Klausur Chemie (OC):</strong> April 2026 (TBD)', style: 'p-4 bg-yellow-50 rounded-lg text-yellow-800' }
                ],
                tasks: [
                    { id: 'task5-1', text: 'Nach Feb-Klausuren: Pause machen!', checked: false, style: '' },
                    { id: 'task5-2', text: 'Ab Ende Feb.: Physiologie-Stoff der Wochentests reaktivieren', checked: false, style: '' },
                    { id: 'task5-3', text: 'Physiologie-Praktikum (M√§rz) intensiv nutzen', checked: false, style: '' },
                    { id: 'task5-4', text: 'Lernplan f√ºr OC-Klausur erstellen', checked: false, style: '' }
                ]
            }
        };

        // Der aktuelle Status der Daten
        let dataState;

        // --- Initialisierung ---
        document.addEventListener('DOMContentLoaded', () => {
            // Aktuelles Datum anzeigen
            currentDateElement.textContent = `Heute: ${now.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            loadStateFromLocalStorage();
            setupGlobalEventListeners();
            renderAllPhases();
            updateOverallProgress();
            highlightPhaseStatus();
        });

        // --- Globale Event-Listener (Event Delegation) ---
        function setupGlobalEventListeners() {
            planContainer.addEventListener('click', (e) => {
                const target = e.target;
                const parent = e.target.closest('span, input, button'); // Klickziel normalisieren
                if (!parent) return;

                // --- Add-Button ---
                if (parent.classList.contains('add-btn')) {
                    const phase = parent.dataset.phase;
                    const type = parent.dataset.type; // 'goals' or 'tasks'
                    const input = document.getElementById(`new-${type.slice(0, -1)}-input-${phase}`);
                    if (input && input.value.trim()) {
                        addItem(phase, type, input.value.trim());
                        input.value = ''; // Input-Feld leeren
                    }
                }

                // --- Delete-Button ---
                if (parent.classList.contains('delete-btn')) {
                    const { phase, type, id } = parent.dataset;
                    deleteItem(phase, type, id);
                }
                
                // --- Learn-Button (AMBOSS) ---
                if (parent.classList.contains('learn-btn')) {
                    const { text } = parent.dataset;
                    // Der Text ist dank .replace() im HTML-Aufbau bereits sauber
                    const encodedText = encodeURIComponent(text);
                    window.open(`https://next.amboss.com/de/search?q=${encodedText}`, '_blank');
                }

                // --- Checkbox ---
                if (parent.matches('input[type="checkbox"]')) {
                    const { phase, id } = parent.dataset;
                    toggleTask(phase, id, parent.checked);
                }
                
                // --- Edit-Span ---
                if (parent.classList.contains('edit-span') && !parent.isContentEditable) {
                    startEditing(parent);
                }
            });
        }
        
        // --- Editier-Logik ---
        function startEditing(span) {
            if (span.dataset.editing === 'true') return;
            span.dataset.editing = 'true';
            
            const { phase, type, id } = span.dataset;
            const originalHtml = span.innerHTML;
            const originalText = span.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editing-input';
            input.value = originalText;

            span.innerHTML = '';
            span.appendChild(input);
            input.focus();
            input.select();

            const save = () => {
                const newText = input.value.trim() || originalText;
                const item = dataState[phase][type].find(i => i.id === id);
                if (item) {
                    // Simples HTML-Parsing, um Formatierung zu erhalten
                    if (originalHtml.includes('<strong>')) {
                         item.text = `<strong>${newText.replace(/<\/?strong>/g, '')}</strong>`;
                    } else if (originalHtml.includes('<br>')) {
                         // Ersetze \n (das ein Input macht) zur√ºck zu <br>
                         item.text = newText.replace(/\n/g, '<br>');
                    }
                    else {
                         item.text = newText;
                    }
                    saveStateToLocalStorage();
                }
                span.innerHTML = item ? item.text : originalHtml;
                span.dataset.editing = 'false';
            };

            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    save();
                } else if (e.key === 'Escape') {
                    span.innerHTML = originalHtml;
                    span.dataset.editing = 'false';
                }
            });
        }

        // --- Alle Phasen auf der UI rendern ---
        function renderAllPhases() {
            Object.keys(dataState).forEach(phase => {
                renderPhase(phase, 'goals');
                renderPhase(phase, 'tasks');
            });
        }

        // --- Eine einzelne Liste (Ziele oder Tasks) rendern ---
        function renderPhase(phase, type) { // type is 'goals' or 'tasks'
            const listElement = document.getElementById(`${phase}-${type}`);
            if (!listElement) return; 
            listElement.innerHTML = ''; 

            if (!dataState[phase] || !dataState[phase][type]) return;

            dataState[phase][type].forEach(item => {
                let li;
                if (type === 'goals') {
                    li = createGoalElement(item, phase);
                } else {
                    li = createTaskElement(item, phase);
                }
                listElement.appendChild(li);
            });
        }
        
        // --- HTML f√ºr ein Ziel-Element erstellen ---
        function createGoalElement(goal, phase) {
            const li = document.createElement('li');
            li.className = `goal-item flex justify-between items-center ${goal.style || 'p-4 bg-gray-50 rounded-lg text-gray-800'}`;
            li.innerHTML = `
                <span class="learn-btn" data-text="${goal.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">üìö</span>
                <span class="edit-span flex-grow" data-phase="${phase}" data-type="goals" data-id="${goal.id}">${goal.text}</span>
                <span data-phase="${phase}" data-type="goals" data-id="${goal.id}" class="delete-btn" title="L√∂schen">X</span>
            `;
            return li;
        }

        // --- HTML f√ºr ein Task-Element erstellen ---
        function createTaskElement(task, phase) {
            const li = document.createElement('li');
            li.className = 'task-item flex justify-between items-center bg-gray-50 p-2 rounded-lg';
            
            const labelStyle = task.style || '';
            const disabled = task.disabled ? 'disabled' : '';

            li.innerHTML = `
                <div class="flex-grow flex items-center">
                    <input type="checkbox" id="${task.id}" data-phase="${phase}" data-id="${task.id}" ${task.checked ? 'checked' : ''} ${disabled} class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 flex-shrink-0">
                    <label for="${task.id}" class="ml-3 ${labelStyle} ${disabled ? 'text-gray-400' : 'text-gray-800'} w-full">
                         <span class="edit-span" data-phase="${phase}" data-type="tasks" data-id="${task.id}">${task.text}</span>
                    </label>
                </div>
                <span class="learn-btn" data-text="${task.text.replace(/<[^>]+>/g, ' ')}" title="In AMBOSS suchen...">üìö</span>
                ${!disabled ? `<span data-phase="${phase}" data-type="tasks" data-id="${task.id}" class="delete-btn" title="L√∂schen">X</span>` : ''}
            `;
            return li;
        }


        // --- CRUD-Logik-Funktionen ---
        
        function addItem(phase, type, text) {
            const newItem = {
                id: `item-${Date.now()}`,
                text: text,
                style: (type === 'goals') ? 'p-4 bg-gray-50 rounded-lg text-gray-800' : '',
                checked: false,
                custom: true
            };
            dataState[phase][type].push(newItem);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        function toggleTask(phase, taskId, isChecked) {
            const task = dataState[phase].tasks.find(t => t.id === taskId);
            if (task) {
                task.checked = isChecked;
                saveStateToLocalStorage();
            }
        }

        function deleteItem(phase, type, id) {
            dataState[phase][type] = dataState[phase][type].filter(item => item.id !== id);
            renderPhase(phase, type);
            saveStateToLocalStorage();
        }

        // --- Daten von localStorage laden ---
        function loadStateFromLocalStorage() {
            statusElement.textContent = "Lade...";
            const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
            
            if (savedState) {
                dataState = JSON.parse(savedState);
                // Stelle sicher, dass alle Phasen/Typen existieren
                Object.keys(defaultData).forEach(phase => {
                    if (!dataState[phase]) {
                        dataState[phase] = defaultData[phase];
                    } else {
                        if (!dataState[phase].goals) dataState[phase].goals = defaultData[phase].goals;
                        if (!dataState[phase].tasks) dataState[phase].tasks = defaultData[phase].tasks;
                    }
                });
            } else {
                dataState = JSON.parse(JSON.stringify(defaultData)); // Tiefe Kopie
            }
            statusElement.textContent = "Bereit";
        }

        // --- Daten in localStorage speichern (mit Debounce) ---
        function saveStateToLocalStorage() {
            clearTimeout(debounceTimer);
            statusElement.textContent = "Speichere...";
            statusElement.classList.add('syncing');
            
            debounceTimer = setTimeout(() => {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataState));
                    statusElement.textContent = "Lokal gespeichert";
                    // UI-Updates nach dem Speichern
                    updateOverallProgress();
                    highlightPhaseStatus();
                } catch (error) {
                    console.error("Fehler beim Speichern in localStorage:", error);
                    statusElement.textContent = "Speicherfehler!";
                } finally {
                    statusElement.classList.remove('syncing');
                }
            }, 1000); // 1 Sekunde Verz√∂gerung
        }
        
        // --- NEUE FUNKTIONEN (V11) ---
        
        // --- Gesamtfortschritt berechnen & anzeigen ---
        function updateOverallProgress() {
            let totalTasks = 0;
            let checkedTasks = 0;
            
            Object.keys(dataState).forEach(phase => {
                dataState[phase].tasks.forEach(task => {
                    if (!task.disabled) { // Blocker (Urlaub etc.) nicht mitz√§hlen
                        totalTasks++;
                        if (task.checked) {
                            checkedTasks++;
                        }
                    }
                });
            });
            
            const percentage = (totalTasks === 0) ? 0 : Math.round((checkedTasks / totalTasks) * 100);
            
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}% (${checkedTasks}/${totalTasks})`;
        }
        
        // --- Phasen-Status (Aktiv, √úberf√§llig) hervorheben ---
        function highlightPhaseStatus() {
            Object.keys(phaseMetadata).forEach(phase => {
                const meta = phaseMetadata[phase];
                const phaseData = dataState[phase];
                const icon = document.getElementById(`${phase}-status`);
                const section = document.getElementById(`${phase}-section`);
                
                if (!icon || !section || !phaseData) return;

                // Status zur√ºcksetzen
                icon.className = 'phase-status-icon';
                section.style.border = 'none';

                // 1. Pr√ºfen, ob alle Tasks erledigt sind
                const openTasks = phaseData.tasks.some(task => !task.checked && !task.disabled);
                if (!openTasks) {
                    icon.classList.add('bg-green-500'); // Gr√ºn: Erledigt
                    icon.title = "Erledigt";
                    section.style.borderColor = '#22c55e'; // green-500
                    return;
                }
                
                // 2. Pr√ºfen auf Zeit-Status
                if (now >= meta.startDate && now <= meta.endDate) {
                    icon.classList.add('bg-blue-500'); // Blau: Aktiv
                    icon.title = "Aktive Phase";
                    section.style.border = '2px solid #3b82f6'; // blue-500
                } else if (now > meta.endDate && openTasks) {
                    icon.classList.add('bg-red-500'); // Rot: √úberf√§llig
                    icon.title = "√úberf√§llig (Aufgaben offen)";
                    section.style.border = '2px solid #ef4444'; // red-500
                } else if (now < meta.startDate) {
                    icon.classList.add('bg-gray-300'); // Grau: Zuk√ºnftig
                    icon.title = "Zuk√ºnftig";
                } else {
                     icon.classList.add('bg-gray-300'); // Grau: Vergangen (aber erledigt)
                    icon.title = "Vergangen";

                }
            });
        }

    </script>
</body>
</html>
